<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Workflow-Generator – Manuel Weiss</title>
    <meta name="description" content="Prozessbeschreibung eingeben – KI erzeugt gültiges BPMN 2.0 XML. Download, Kopieren oder in demo.bpmn.io öffnen.">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/starry-background.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.4.0/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.4.0/dist/assets/bpmn-font/css/bpmn-embedded.css">
    <style>
        body { padding-top: 70px; min-height: 100vh; }
        .bpmn-page { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        
        .bpmn-hero {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.25) 0%, rgba(139, 92, 246, 0.25) 100%);
            border-radius: 16px;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.15);
        }
        .bpmn-hero h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #ffffff; }
        .bpmn-hero p { opacity: 0.9; font-size: 0.95rem; color: #ffffff; margin: 0; }
        
        .bpmn-main-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            align-items: start;
        }
        
        .bpmn-input-panel {
            background: rgba(255,255,255,0.97);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 90px;
        }
        
        .bpmn-input-panel label { 
            display: block; 
            margin-bottom: 0.5rem; 
            font-weight: 600; 
            color: #1e293b;
            font-size: 0.95rem;
        }
        .bpmn-input-panel label i { margin-right: 0.35rem; color: #667eea; }
        
        #bpmnProcessText {
            width: 100%; 
            min-height: 200px; 
            padding: 0.75rem;
            border: 2px solid #e2e8f0; 
            border-radius: 10px;
            font-size: 0.9rem; 
            resize: vertical; 
            font-family: inherit;
            line-height: 1.5;
            box-sizing: border-box;
        }
        #bpmnProcessText:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        
        #bpmnGenerateBtn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            padding: 0.875rem 1.5rem;
            border-radius: 10px; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            transition: all 0.2s;
        }
        #bpmnGenerateBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        #bpmnGenerateBtn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        #bpmnStatus { 
            display: block;
            margin-top: 0.75rem; 
            color: #64748b; 
            font-size: 0.85rem; 
            text-align: center;
        }
        
        .bpmn-hint-text {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f0f9ff;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #0369a1;
            line-height: 1.4;
        }
        .bpmn-hint-text i { margin-right: 0.25rem; }
        
        .bpmn-diagram-panel {
            background: rgba(255,255,255,0.97);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .bpmn-diagram-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .bpmn-diagram-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }
        .bpmn-diagram-header h3 i { margin-right: 0.5rem; }
        .bpmn-diagram-actions {
            display: flex;
            gap: 0.5rem;
        }
        .bpmn-diagram-actions button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            transition: background 0.2s;
        }
        .bpmn-diagram-actions button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        #bpmnDiagramContainer { 
            height: 500px; 
            background: #fafafa; 
        }
        #bpmnDiagramContainer .bjs-container { border-radius: 0; }
        
        .bpmn-editor-hint { 
            padding: 0.6rem 1rem;
            background: #f8fafc;
            font-size: 0.8rem; 
            color: #64748b; 
            border-top: 1px solid #e2e8f0;
            text-align: center;
        }
        .bpmn-editor-hint i { color: #667eea; margin-right: 0.25rem; }
        
        .bpmn-tabs-section {
            margin-top: 1.5rem;
        }
        .bpmn-result-tabs { 
            display: flex; 
            gap: 0; 
            border-bottom: 2px solid #e2e8f0;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }
        .bpmn-result-tabs button { 
            padding: 0.75rem 1.25rem; 
            border: none; 
            background: none; 
            cursor: pointer; 
            font-weight: 600; 
            color: #64748b; 
            border-bottom: 2px solid transparent; 
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .bpmn-result-tabs button:hover { color: #667eea; background: #f8fafc; }
        .bpmn-result-tabs button.active { color: #667eea; border-bottom-color: #667eea; background: white; }
        
        .bpmn-tab-content {
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 1rem;
            display: none;
        }
        .bpmn-tab-content.show { display: block; }
        
        #bpmnXmlOutput {
            background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px;
            overflow: auto; max-height: 300px; font-size: 0.8rem; white-space: pre-wrap; word-break: break-all;
        }
        
        #bpmnError { 
            margin-top: 1rem; 
            padding: 1rem; 
            background: #fee2e2; 
            color: #991b1b; 
            border-radius: 8px;
            display: none;
        }
        
        .bpmn-raci-hint { font-size: 0.85rem; color: #64748b; margin-bottom: 0.75rem; }
        .bpmn-task-form { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .bpmn-task-form label { display: block; margin-top: 0.5rem; font-weight: 600; color: #334155; font-size: 0.85rem; }
        .bpmn-task-form input, .bpmn-task-form textarea { width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; margin-top: 0.25rem; box-sizing: border-box; }
        .bpmn-task-form textarea { min-height: 50px; resize: vertical; }
        .bpmn-raci-table-wrap { overflow-x: auto; }
        .bpmn-raci-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .bpmn-raci-table th, .bpmn-raci-table td { border: 1px solid #e2e8f0; padding: 0.4rem 0.6rem; text-align: left; }
        .bpmn-raci-table th { background: #f1f5f9; font-weight: 600; color: #1e293b; }
        .bpmn-raci-table tr:hover { background: #f8fafc; }
        .raci-badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .raci-r { background: #dbeafe; color: #1e40af; }
        .raci-a { background: #d1fae5; color: #065f46; }
        .raci-c { background: #fef3c7; color: #92400e; }
        .raci-i { background: #e0e7ff; color: #3730a3; }
        
        .bpmn-info-box {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #fffbeb;
            border-radius: 8px;
            border-left: 3px solid #d97706;
            font-size: 0.8rem;
            color: #92400e;
        }
        .bpmn-info-box i { margin-right: 0.25rem; }
        
        @media (max-width: 900px) {
            .bpmn-main-layout {
                grid-template-columns: 1fr;
            }
            .bpmn-input-panel {
                position: static;
            }
            #bpmnDiagramContainer {
                height: 400px;
            }
            .bpmn-diagram-header {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .bpmn-diagram-actions {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 600px) {
            .bpmn-page { padding: 1rem; }
            .bpmn-hero { padding: 1rem; }
            .bpmn-hero h1 { font-size: 1.25rem; }
            .bpmn-input-panel { padding: 1rem; }
            #bpmnProcessText { min-height: 140px; font-size: 0.9rem; }
            #bpmnDiagramContainer { height: 350px; }
            .bpmn-result-tabs button { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
        }
    </style>
</head>
<body class="starry-theme">
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="manuel-weiss-photo.svg" alt="MW" class="nav-logo">
                <span class="nav-name">Manuel Weiss</span>
            </div>
            <div class="nav-menu" id="navMenu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="hr-prozessautomatisierung.html" class="nav-link">HR-Automatisierung</a>
                <a href="hr-selbsttest.html" class="nav-link">HR-Selbsttest</a>
                <a href="index.html#about" class="nav-link">Über mich</a>
                <a href="index.html#contact" class="nav-link">Kontakt</a>
            </div>
            <div class="nav-toggle" id="navToggle"><span></span></div>
        </div>
    </nav>

    <main class="bpmn-page">
        <div class="bpmn-hero">
            <h1><i class="fas fa-project-diagram"></i> BPMN Workflow-Generator</h1>
            <p>Beschreiben Sie Ihren Prozess – die KI erstellt ein bearbeitbares BPMN-Diagramm</p>
        </div>

        <div class="bpmn-main-layout">
            <div class="bpmn-input-panel">
                <label for="bpmnProcessText"><i class="fas fa-pen"></i> Prozessbeschreibung</label>
                <textarea id="bpmnProcessText" placeholder="Beschreiben Sie Ihren Prozess...

Beispiel:
Mitarbeiter stellt Urlaubsantrag.
Teamleitung genehmigt oder lehnt ab.
Bei Genehmigung: HR bucht Urlaub.
Bei Ablehnung: Mitarbeiter wird informiert."></textarea>
                
                <button type="button" id="bpmnGenerateBtn">
                    <i class="fas fa-magic"></i> Workflow generieren
                </button>
                <span id="bpmnStatus"></span>
                
                <div class="bpmn-hint-text">
                    <i class="fas fa-lightbulb"></i> <strong>Tipp:</strong> Beschreiben Sie Rollen, Entscheidungen und Systeme für bessere Ergebnisse.
                </div>
                
                <p id="bpmnKeyStatus" style="margin-top: 0.75rem; font-size: 0.8rem; color: #64748b;"></p>
            </div>
            
            <div class="bpmn-diagram-panel">
                <div class="bpmn-diagram-header">
                    <h3><i class="fas fa-sitemap"></i> Prozess-Workflow</h3>
                    <div class="bpmn-diagram-actions">
                        <button type="button" id="bpmnCopyBtn"><i class="fas fa-copy"></i> Kopieren</button>
                        <button type="button" id="bpmnDownloadBtn"><i class="fas fa-download"></i> .bpmn</button>
                        <button type="button" id="bpmnOpenDemoBtn"><i class="fas fa-external-link-alt"></i> bpmn.io</button>
                    </div>
                </div>
                <div id="bpmnDiagramContainer"></div>
                <div class="bpmn-editor-hint">
                    <i class="fas fa-edit"></i> Elemente anklicken zum Bearbeiten • <i class="fas fa-search-plus"></i> Ctrl/Shift+Mausrad zoomen • Palette links für neue Elemente
                </div>
            </div>
        </div>
        
        <div class="bpmn-tabs-section">
            <div class="bpmn-result-tabs">
                <button type="button" id="bpmnTabRaci" class="active"><i class="fas fa-users-cog"></i> Rollen & RACI</button>
                <button type="button" id="bpmnTabXml"><i class="fas fa-code"></i> XML-Code</button>
            </div>
            <div class="bpmn-tab-content show" id="bpmnRaciWrap">
                <p class="bpmn-raci-hint"><i class="fas fa-mouse-pointer"></i> Task im Diagramm anklicken, dann Rolle, IT-System und RACI erfassen.</p>
                <div class="bpmn-task-form" id="bpmnTaskForm" style="display: none;">
                    <strong id="bpmnTaskFormTitle">Task auswählen</strong>
                    <input type="hidden" id="bpmnTaskFormId">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <div>
                            <label>Rolle</label>
                            <input type="text" id="bpmnMetaRolle" placeholder="z.B. HR">
                        </div>
                        <div>
                            <label>IT-System</label>
                            <input type="text" id="bpmnMetaItSystem" placeholder="z.B. SAP">
                        </div>
                    </div>
                    <label>Beschreibung</label>
                    <textarea id="bpmnMetaBeschreibung" placeholder="Kurze Beschreibung"></textarea>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                        <div><label>R</label><input type="text" id="bpmnMetaR" placeholder="Ausführend"></div>
                        <div><label>A</label><input type="text" id="bpmnMetaA" placeholder="Verantwortl."></div>
                        <div><label>C</label><input type="text" id="bpmnMetaC" placeholder="Konsultiert"></div>
                        <div><label>I</label><input type="text" id="bpmnMetaI" placeholder="Informiert"></div>
                    </div>
                    <button type="button" id="bpmnMetaSave" style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%;"><i class="fas fa-save"></i> Speichern</button>
                </div>
                <div class="bpmn-raci-table-wrap">
                    <table class="bpmn-raci-table" id="bpmnRaciTable">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>R</th>
                                <th>A</th>
                                <th>C</th>
                                <th>I</th>
                                <th>Rolle</th>
                                <th>System</th>
                            </tr>
                        </thead>
                        <tbody id="bpmnRaciTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="bpmn-tab-content" id="bpmnXmlWrap">
                <pre id="bpmnXmlOutput"></pre>
            </div>
        </div>
        
        <div id="bpmnError"></div>
        
        <div id="bpmnResultArea" style="display:none;"></div>
        <div id="bpmnInterpretationWrap" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
            <strong style="color: #0369a1;"><i class="fas fa-lightbulb"></i> Interpretation</strong>
            <pre id="bpmnInterpretation" style="margin: 0.5rem 0 0; white-space: pre-wrap; font-size: 0.85rem; color: #1e293b;"></pre>
        </div>
        <div id="bpmnAssumptionsWrap" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #fffbeb; border-radius: 8px; border-left: 4px solid #d97706;">
            <strong style="color: #92400e;"><i class="fas fa-info-circle"></i> Annahmen</strong>
            <pre id="bpmnAssumptions" style="margin: 0.5rem 0 0; white-space: pre-wrap; font-size: 0.85rem; color: #1e293b;"></pre>
        </div>
        <div id="bpmnDiagramWrap" style="display:none;"></div>

        <p style="text-align: center; margin-top: 2rem;">
            <a href="hr-prozessautomatisierung.html" style="color: #667eea;">← Zurück zur HR-Prozessautomatisierung</a>
        </p>
    </main>

    <script src="https://unpkg.com/bpmn-js@17.4.0/dist/bpmn-modeler.development.js"></script>
    <script src="js/aws-app-config.js"></script>
    <script src="js/aws-api-settings.js"></script>
    <script>
(function() {
    var currentBpmnXml = null;
    var bpmnModeler = null;
    var taskMeta = {};

    var MW_NS = 'http://manuel-weiss.ch/bpmn/ext';

    var EXAMPLE_PROCESS_TEXT =
        'Mitarbeiter füllt Ferien Antrag aus\n' +
        'Teamleitung bestätigt oder lehnt ab\n' +
        'Bereichsleitung bestätigt oder lehnt ab\n' +
        'HR hinterlegt Urlaub in Zeitsystem und erstellt Bestätigung die im Dossier abgelegt wird\n' +
        'Payroll veranlasst Auszahlung Urlaubsgeld\n' +
        'Ende';

    function extractRaciFromXml(xml) {
        taskMeta = {};
        if (!xml || typeof xml !== 'string') return;
        try {
            var parser = new DOMParser();
            var doc = parser.parseFromString(xml, 'application/xml');
            var tasks = [];
            var q = doc.querySelectorAll('bpmn\\:task');
            for (var qi = 0; qi < q.length; qi++) tasks.push(q[qi]);
            if (!tasks.length) {
                var any = doc.getElementsByTagName('*');
                for (var k = 0; k < any.length; k++) {
                    if (any[k].localName === 'task' || (any[k].tagName && any[k].tagName.indexOf('task') >= 0)) tasks.push(any[k]);
                }
            }
            for (var i = 0; i < tasks.length; i++) {
                var task = tasks[i];
                var id = task.getAttribute('id');
                if (!id) continue;
                var ext = task.querySelector('bpmn\\:extensionElements') || task.getElementsByTagName('extensionElements')[0];
                if (!ext) continue;
                var meta = ext.querySelector('mw\\:taskMeta') || ext.getElementsByTagNameNS(MW_NS, 'taskMeta')[0];
                if (!meta) {
                    var list = ext.getElementsByTagName('*');
                    for (var j = 0; j < list.length; j++) { if (list[j].localName === 'taskMeta') { meta = list[j]; break; } }
                }
                if (!meta) continue;
                function text(m, tag) {
                    var n = m.getElementsByTagNameNS ? m.getElementsByTagNameNS(MW_NS, tag)[0] : m.querySelector(tag + ', mw\\:' + tag);
                    return n ? n.textContent.trim() : '';
                }
                taskMeta[id] = {
                    rolle: text(meta, 'rolle'),
                    itSystem: text(meta, 'itSystem'),
                    beschreibung: text(meta, 'beschreibung'),
                    raciR: text(meta, 'raciR'),
                    raciA: text(meta, 'raciA'),
                    raciC: text(meta, 'raciC'),
                    raciI: text(meta, 'raciI')
                };
            }
        } catch (e) { console.warn('extractRaciFromXml:', e); }
    }

    function injectRaciIntoXml(xml) {
        if (!xml) return xml;
        if (Object.keys(taskMeta).length === 0) return xml;
        try {
            var parser = new DOMParser();
            var doc = parser.parseFromString(xml, 'application/xml');
            var taskList = [];
            var t1 = doc.getElementsByTagName('bpmn:task');
            for (var ti = 0; ti < t1.length; ti++) taskList.push(t1[ti]);
            if (!taskList.length) {
                var t2 = doc.querySelectorAll('bpmn\\:task');
                for (ti = 0; ti < t2.length; ti++) taskList.push(t2[ti]);
            }
            if (!taskList.length) {
                var all = doc.getElementsByTagName('*');
                for (var q = 0; q < all.length; q++) { if (all[q].localName === 'task') taskList.push(all[q]); }
            }
            for (var i = 0; i < taskList.length; i++) {
                var task = taskList[i];
                var id = task.getAttribute('id');
                var m = taskMeta[id];
                if (!m || (!m.rolle && !m.itSystem && !m.beschreibung && !m.raciR && !m.raciA && !m.raciC && !m.raciI)) continue;
                var ext = task.getElementsByTagName('extensionElements')[0] || task.querySelector('bpmn\\:extensionElements');
                if (!ext) {
                    ext = doc.createElementNS('http://www.omg.org/spec/BPMN/20100524/MODEL', 'extensionElements');
                    ext.prefix = 'bpmn';
                    task.insertBefore(ext, task.firstChild);
                }
                var existing = ext.getElementsByTagNameNS(MW_NS, 'taskMeta');
                for (var r = existing.length - 1; r >= 0; r--) ext.removeChild(existing[r]);
                var meta = doc.createElementNS(MW_NS, 'taskMeta');
                meta.prefix = 'mw';
                function add(el, val) { if (val) { var c = doc.createElementNS(MW_NS, el); c.prefix = 'mw'; c.textContent = val; meta.appendChild(c); } }
                add('rolle', m.rolle);
                add('itSystem', m.itSystem);
                add('beschreibung', m.beschreibung);
                add('raciR', m.raciR);
                add('raciA', m.raciA);
                add('raciC', m.raciC);
                add('raciI', m.raciI);
                ext.appendChild(meta);
            }
            if (!doc.documentElement.getAttribute('xmlns:mw')) doc.documentElement.setAttribute('xmlns:mw', MW_NS);
            return new XMLSerializer().serializeToString(doc);
        } catch (e) { console.warn('injectRaciIntoXml:', e); return xml; }
    }

    function refreshRaciTable() {
        var tbody = document.getElementById('bpmnRaciTableBody');
        if (!tbody || !bpmnModeler) return;
        tbody.innerHTML = '';
        var registry = bpmnModeler.get('elementRegistry');
        var all = registry.getAll();
        var tasks = all.filter(function(el) { return el.type === 'bpmn:Task' || (el.businessObject && el.businessObject.$type === 'bpmn:Task'); });
        tasks.forEach(function(el) {
            var id = el.id;
            var name = (el.businessObject && el.businessObject.name) || id;
            var m = taskMeta[id] || {};
            var tr = document.createElement('tr');
            tr.innerHTML =
                '<td><strong>' + escapeHtml(name) + '</strong></td>' +
                '<td>' + (m.raciR ? '<span class="raci-badge raci-r">' + escapeHtml(m.raciR) + '</span>' : '–') + '</td>' +
                '<td>' + (m.raciA ? '<span class="raci-badge raci-a">' + escapeHtml(m.raciA) + '</span>' : '–') + '</td>' +
                '<td>' + (m.raciC ? '<span class="raci-badge raci-c">' + escapeHtml(m.raciC) + '</span>' : '–') + '</td>' +
                '<td>' + (m.raciI ? '<span class="raci-badge raci-i">' + escapeHtml(m.raciI) + '</span>' : '–') + '</td>' +
                '<td>' + escapeHtml(m.rolle || '') + '</td>' +
                '<td>' + escapeHtml(m.itSystem || '') + '</td>';
            tbody.appendChild(tr);
        });
        if (tasks.length === 0) tbody.innerHTML = '<tr><td colspan="7">Keine Tasks im Diagramm. Bitte zuerst BPMN generieren.</td></tr>';
    }

    function escapeHtml(s) {
        if (!s) return '';
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    function setupSelectionListener() {
        if (!bpmnModeler) return;
        var eventBus = bpmnModeler.get('eventBus');
        var form = document.getElementById('bpmnTaskForm');
        var formTitle = document.getElementById('bpmnTaskFormTitle');
        var formId = document.getElementById('bpmnTaskFormId');
        eventBus.on('selection.changed', function(e) {
            var sel = e.newSelection || [];
            var task = sel.length === 1 && (sel[0].type === 'bpmn:Task' || (sel[0].businessObject && sel[0].businessObject.$type === 'bpmn:Task')) ? sel[0] : null;
            if (!task) {
                form.style.display = 'none';
                return;
            }
            var id = task.id;
            formId.value = id;
            formTitle.textContent = 'Task: ' + ((task.businessObject && task.businessObject.name) || id);
            var m = taskMeta[id] || {};
            document.getElementById('bpmnMetaRolle').value = m.rolle || '';
            document.getElementById('bpmnMetaItSystem').value = m.itSystem || '';
            document.getElementById('bpmnMetaBeschreibung').value = m.beschreibung || '';
            document.getElementById('bpmnMetaR').value = m.raciR || '';
            document.getElementById('bpmnMetaA').value = m.raciA || '';
            document.getElementById('bpmnMetaC').value = m.raciC || '';
            document.getElementById('bpmnMetaI').value = m.raciI || '';
            form.style.display = 'block';
        });
    }

    function saveTaskMeta() {
        var id = document.getElementById('bpmnTaskFormId').value;
        if (!id) return;
        taskMeta[id] = {
            rolle: document.getElementById('bpmnMetaRolle').value.trim(),
            itSystem: document.getElementById('bpmnMetaItSystem').value.trim(),
            beschreibung: document.getElementById('bpmnMetaBeschreibung').value.trim(),
            raciR: document.getElementById('bpmnMetaR').value.trim(),
            raciA: document.getElementById('bpmnMetaA').value.trim(),
            raciC: document.getElementById('bpmnMetaC').value.trim(),
            raciI: document.getElementById('bpmnMetaI').value.trim()
        };
        refreshRaciTable();
    }

    function sanitizeBpmnXml(xml) {
        if (!xml || typeof xml !== 'string') return xml;
        return xml.replace(/\s+name="([^"]*)"/g, function(m, val) {
            var clean = val.replace(/\r?\n/g, ' ').replace(/\s+/g, ' ').trim();
            return ' name="' + clean + '"';
        });
    }

    function renderBpmnEditor(xml) {
        var container = document.getElementById('bpmnDiagramContainer');
        if (!container || !xml) return;
        xml = sanitizeBpmnXml(xml);
        extractRaciFromXml(xml);
        var ModelerClass = window.BpmnModeler || window.BpmnJS;
        if (!ModelerClass) {
            container.innerHTML = '<div style="padding:2rem;text-align:center;color:#b91c1c;">BPMN-Editor konnte nicht geladen werden (BpmnModeler nicht gefunden). Bitte Seite neu laden.</div>';
            return;
        }
        if (!bpmnModeler) {
            container.innerHTML = '';
            bpmnModeler = new ModelerClass({ 
                container: container,
                keyboard: { bindTo: document },
                // Aktiviere direktes Mausrad-Zoomen ohne Ctrl-Taste
                zoomScroll: {
                    enabled: true
                }
            });
            setupSelectionListener();
            
            // Zusätzlich: Manuelles Zoom mit Shift+Mausrad als Fallback
            container.addEventListener('wheel', function(e) {
                if (!e.shiftKey) return;
                e.preventDefault();
                try {
                    var canvas = bpmnModeler.get('canvas');
                    var currentZoom = canvas.zoom();
                    var factor = e.deltaY < 0 ? 1.1 : 0.9;
                    var newZoom = Math.max(0.2, Math.min(4, currentZoom * factor));
                    canvas.zoom(newZoom);
                } catch(err) {}
            }, { passive: false });
        }
        bpmnModeler.importXML(xml).then(function() {
            var canvas = bpmnModeler.get('canvas');
            if (canvas && canvas.zoom) {
                setTimeout(function() { canvas.zoom('fit-viewport'); }, 100);
            }
            refreshRaciTable();
        }).catch(function(err) {
            console.error('BPMN import failed:', err);
            var msg = '<div style="padding:2rem;text-align:center;color:#b91c1c;">Diagramm konnte nicht geladen werden: ' + (err && err.message ? err.message : 'Siehe Konsole') + '. <a href="#" id="bpmnShowXmlTab" style="color:#667eea;">XML-Ansicht</a> prüfen.</div>';
            container.innerHTML = msg;
            container.querySelector('#bpmnShowXmlTab') && container.querySelector('#bpmnShowXmlTab').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('bpmnTabXml').click();
            });
        });
    }

    function getCurrentXmlFromEditor(cb) {
        if (!bpmnModeler || typeof bpmnModeler.saveXML !== 'function') {
            if (cb) cb(null, currentBpmnXml);
            return;
        }
        bpmnModeler.saveXML({ format: true }).then(function(result) {
            var xml = result && result.xml ? result.xml : null;
            if (xml) xml = injectRaciIntoXml(xml);
            if (xml) currentBpmnXml = xml;
            if (cb) cb(null, xml);
        }).catch(function(err) {
            if (cb) cb(err, currentBpmnXml);
        });
    }

    function autoDownloadBpmnFromXml(xml) {
        if (!xml || typeof xml !== 'string') return;
        try {
            var blob = new Blob([xml], { type: 'application/xml' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'prozess.bpmn';
            a.click();
            setStatus('Download der .bpmn-Datei gestartet.');
            setTimeout(function() { setStatus(''); }, 2000);
        } catch (e) {
            console.warn('Automatischer BPMN-Download fehlgeschlagen:', e);
        }
    }

    function showResult(xml, interpretation, assumptions) {
        currentBpmnXml = xml;
        var area = document.getElementById('bpmnResultArea');
        var pre = document.getElementById('bpmnXmlOutput');
        var err = document.getElementById('bpmnError');
        if (area) area.style.display = 'block';
        if (pre) pre.textContent = xml;
        if (err) { err.style.display = 'none'; err.textContent = ''; }
        var iWrap = document.getElementById('bpmnInterpretationWrap');
        var iPre = document.getElementById('bpmnInterpretation');
        var aWrap = document.getElementById('bpmnAssumptionsWrap');
        var aPre = document.getElementById('bpmnAssumptions');
        if (iWrap && iPre) {
            if (interpretation && interpretation.trim()) { iPre.textContent = interpretation.trim(); iWrap.style.display = 'block'; }
            else { iWrap.style.display = 'none'; iPre.textContent = ''; }
        }
        if (aWrap && aPre) {
            if (assumptions && assumptions.trim()) { aPre.textContent = assumptions.trim(); aWrap.style.display = 'block'; }
            else { aWrap.style.display = 'none'; aPre.textContent = ''; }
        }

        renderBpmnEditor(xml);
        autoDownloadBpmnFromXml(xml);
    }

    function apiUrl() {
        return (window.getApiUrl && window.getApiUrl('TEXT_TO_BPMN_GPT')) ||
            (window.AWS_APP_CONFIG && window.AWS_APP_CONFIG.API_BASE ? window.AWS_APP_CONFIG.API_BASE + '/text-to-bpmn-gpt' : '');
    }

    function setStatus(t) {
        var el = document.getElementById('bpmnStatus');
        if (el) el.textContent = t;
    }

    function setBusy(busy) {
        var btn = document.getElementById('bpmnGenerateBtn');
        if (btn) {
            btn.disabled = busy;
            btn.innerHTML = busy ? '<i class="fas fa-spinner fa-spin"></i> Generiere…' : '<i class="fas fa-magic"></i> Workflow generieren';
        }
        if (!busy) setStatus('');
    }

    function showError(msg) {
        var err = document.getElementById('bpmnError');
        if (err) { err.style.display = 'block'; err.textContent = msg; }
    }

    async function generateBpmn() {
        var text = (document.getElementById('bpmnProcessText') || {}).value || '';
        if (!text.trim()) {
            showError('Bitte eine Prozessbeschreibung eingeben.');
            return;
        }

        var openaiApiKey = '';
        if (window.awsAPISettings && typeof window.awsAPISettings.getFullApiKey === 'function') {
            try {
                var key = await window.awsAPISettings.getFullApiKey('openai');
                if (key && typeof key === 'string' && key.length > 10) openaiApiKey = key;
            } catch (e) { console.warn('OpenAI-Key nicht geladen, Fallback:', e); }
        }

        var url = apiUrl();
        if (!url) {
            showError('API-URL ist nicht konfiguriert.');
            return;
        }

        setBusy(true);
        setStatus('Rufe API auf…');

        try {
            var res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text.trim(), openaiApiKey: openaiApiKey })
            });
            var data = await res.json().catch(function() { return {}; });

            if (!res.ok) {
                showError(data.error || res.statusText || 'Unbekannter Fehler');
                return;
            }
            if (data.success && data.bpmnXml) {
                showResult(data.bpmnXml, data.interpretation, data.assumptions);
            } else {
                showError(data.error || 'Kein BPMN-XML in der Antwort.');
            }
        } catch (e) {
            showError(e.message || 'Netzwerk- oder Fehler beim Aufruf.');
        } finally {
            setBusy(false);
        }
    }

    function copyXml() {
        getCurrentXmlFromEditor(function(err, xml) {
            var toCopy = xml || currentBpmnXml;
            if (!toCopy) return;
            navigator.clipboard.writeText(toCopy).then(function() {
                setStatus('In Zwischenablage kopiert.');
                setTimeout(function() { setStatus(''); }, 2000);
            }).catch(function() { showError('Kopieren fehlgeschlagen.'); });
        });
    }

    function downloadBpmn() {
        getCurrentXmlFromEditor(function(err, xml) {
            var toSave = xml || currentBpmnXml;
            if (!toSave) return;
            var blob = new Blob([toSave], { type: 'application/xml' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'prozess.bpmn';
            a.click();
            URL.revokeObjectURL(a.href);
            setStatus('Download gestartet.');
            setTimeout(function() { setStatus(''); }, 2000);
        });
    }

    function openInDemoBpmnIo() {
        getCurrentXmlFromEditor(function(err, xml) {
            var toCopy = xml || currentBpmnXml;
            if (!toCopy) return;
            navigator.clipboard.writeText(toCopy).then(function() {
                window.open('https://demo.bpmn.io/new', '_blank');
                setStatus('XML kopiert. In demo.bpmn.io mit Strg+V einfügen.');
                setTimeout(function() { setStatus(''); }, 4000);
            }).catch(function() { showError('Kopieren fehlgeschlagen.'); });
        });
    }

    var processTextEl = document.getElementById('bpmnProcessText');
    if (processTextEl) {
        processTextEl.value = EXAMPLE_PROCESS_TEXT;
        processTextEl.dataset.example = 'true';
        processTextEl.addEventListener('focus', function() {
            if (processTextEl.dataset.example === 'true') {
                processTextEl.value = '';
                processTextEl.dataset.example = 'false';
            }
        });
        processTextEl.addEventListener('input', function() {
            processTextEl.dataset.example = 'false';
        });
    }

    document.getElementById('bpmnGenerateBtn').addEventListener('click', generateBpmn);
    document.getElementById('bpmnCopyBtn').addEventListener('click', copyXml);
    document.getElementById('bpmnDownloadBtn').addEventListener('click', downloadBpmn);
    document.getElementById('bpmnOpenDemoBtn').addEventListener('click', openInDemoBpmnIo);

    document.getElementById('bpmnTabRaci').addEventListener('click', function() {
        document.getElementById('bpmnTabRaci').classList.add('active');
        document.getElementById('bpmnTabXml').classList.remove('active');
        document.getElementById('bpmnRaciWrap').classList.add('show');
        document.getElementById('bpmnXmlWrap').classList.remove('show');
        refreshRaciTable();
    });
    document.getElementById('bpmnTabXml').addEventListener('click', function() {
        document.getElementById('bpmnTabXml').classList.add('active');
        document.getElementById('bpmnTabRaci').classList.remove('active');
        document.getElementById('bpmnXmlWrap').classList.add('show');
        document.getElementById('bpmnRaciWrap').classList.remove('show');
        getCurrentXmlFromEditor(function(err, xml) {
            if (xml && document.getElementById('bpmnXmlOutput')) document.getElementById('bpmnXmlOutput').textContent = xml;
        });
    });
    document.getElementById('bpmnMetaSave').addEventListener('click', saveTaskMeta);

    (function checkKeyStatus() {
        var el = document.getElementById('bpmnKeyStatus');
        if (!el) return;
        if (!window.awsAPISettings || typeof window.awsAPISettings.getFullApiKey !== 'function') {
            el.innerHTML = '<span style="color:#64748b;">OpenAI-Key wird geladen…</span>';
            setTimeout(checkKeyStatus, 500);
            return;
        }
        window.awsAPISettings.getFullApiKey('openai').then(function(key) {
            if (key && typeof key === 'string' && key.length > 10) {
                el.innerHTML = '<span style="color:#059669;"><i class="fas fa-check-circle"></i> API-Key geladen</span>';
            } else {
                el.innerHTML = '<span style="color:#64748b;"><i class="fas fa-info-circle"></i> Kein API-Key – <a href="admin.html#api-keys" style="color:#667eea;">hier eintragen</a></span>';
            }
        }).catch(function() {
            el.innerHTML = '<span style="color:#64748b;"><i class="fas fa-info-circle"></i> Kein API-Key</span>';
        });
    })();
})();
    </script>
</body>
</html>
