<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login-Funktionalit√§t Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Login-Funktionalit√§t Test</h1>
    
    <div class="test-section">
        <h2>1. System-Initialisierung pr√ºfen</h2>
        <button onclick="testSystemInit()">System pr√ºfen</button>
        <div id="initResult"></div>
    </div>
    
    <div class="test-section">
        <h2>2. AWS Cognito Konfiguration pr√ºfen</h2>
        <button onclick="testAWSConfig()">Konfiguration pr√ºfen</button>
        <div id="configResult"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Benutzer-Status pr√ºfen</h2>
        <input type="email" id="testEmail" placeholder="E-Mail-Adresse" value="weiss-manuel@gmx.de">
        <button onclick="testUserStatus()">Benutzer-Status pr√ºfen</button>
        <div id="userStatusResult"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Login testen</h2>
        <input type="email" id="loginEmail" placeholder="E-Mail-Adresse" value="weiss-manuel@gmx.de">
        <input type="password" id="loginPassword" placeholder="Passwort">
        <button onclick="testLogin()">Login testen</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Session pr√ºfen</h2>
        <button onclick="testSession()">Session pr√ºfen</button>
        <div id="sessionResult"></div>
    </div>
    
    <div class="test-section">
        <h2>6. Vollst√§ndiger Test</h2>
        <button onclick="runFullTest()">Alle Tests ausf√ºhren</button>
        <div id="fullTestResult"></div>
    </div>

    <!-- AWS Config -->
    <script src="js/aws-config.js"></script>
    <!-- AWS SDK -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1490.0.min.js"></script>
    <!-- Auth System -->
    <script src="js/real-user-auth-system.js"></script>

    <script>
        function addResult(elementId, message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            document.getElementById(elementId).appendChild(div);
        }

        function clearResult(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testSystemInit() {
            clearResult('initResult');
            addResult('initResult', 'üîÑ Pr√ºfe System-Initialisierung...', 'info');
            
            const checks = [];
            
            // Pr√ºfe AWS SDK
            if (typeof AWS !== 'undefined') {
                checks.push('‚úÖ AWS SDK geladen');
            } else {
                checks.push('‚ùå AWS SDK nicht geladen');
            }
            
            // Pr√ºfe AWS Config
            if (window.AWS_CONFIG) {
                checks.push('‚úÖ AWS_CONFIG vorhanden');
                checks.push(`   - User Pool ID: ${window.AWS_CONFIG.userPoolId}`);
                checks.push(`   - Client ID: ${window.AWS_CONFIG.clientId}`);
                checks.push(`   - Region: ${window.AWS_CONFIG.region}`);
            } else {
                checks.push('‚ùå AWS_CONFIG nicht vorhanden');
            }
            
            // Pr√ºfe Auth System
            if (window.realUserAuth) {
                checks.push('‚úÖ realUserAuth System vorhanden');
                checks.push(`   - Initialisiert: ${window.realUserAuth.isInitialized ? 'Ja' : 'Nein'}`);
                checks.push(`   - Angemeldet: ${window.realUserAuth.isLoggedIn() ? 'Ja' : 'Nein'}`);
            } else {
                checks.push('‚ùå realUserAuth System nicht vorhanden');
            }
            
            // Pr√ºfe Cognito Service
            if (window.realUserAuth && window.realUserAuth.cognitoIdentityServiceProvider) {
                checks.push('‚úÖ Cognito Identity Service Provider initialisiert');
            } else {
                checks.push('‚ùå Cognito Identity Service Provider nicht initialisiert');
            }
            
            checks.forEach(check => {
                addResult('initResult', check, check.startsWith('‚úÖ') ? 'success' : 'error');
            });
        }

        async function testAWSConfig() {
            clearResult('configResult');
            addResult('configResult', 'üîÑ Pr√ºfe AWS Cognito Konfiguration...', 'info');
            
            if (!window.AWS_CONFIG) {
                addResult('configResult', '‚ùå AWS_CONFIG nicht gefunden', 'error');
                return;
            }
            
            const config = window.AWS_CONFIG;
            const details = [
                `User Pool ID: ${config.userPoolId}`,
                `Client ID: ${config.clientId}`,
                `Region: ${config.region}`
            ];
            
            details.forEach(detail => {
                addResult('configResult', `‚ÑπÔ∏è ${detail}`, 'info');
            });
            
            // Pr√ºfe ob User Pool existiert (nur wenn AWS SDK geladen)
            if (typeof AWS !== 'undefined' && window.realUserAuth && window.realUserAuth.isInitialized) {
                try {
                    AWS.config.region = config.region;
                    const cognito = new AWS.CognitoIdentityServiceProvider({ region: config.region });
                    
                    // Versuche User Pool zu beschreiben
                    try {
                        await cognito.describeUserPool({ UserPoolId: config.userPoolId }).promise();
                        addResult('configResult', '‚úÖ User Pool ist erreichbar', 'success');
                    } catch (error) {
                        addResult('configResult', `‚ùå User Pool nicht erreichbar: ${error.message}`, 'error');
                    }
                } catch (error) {
                    addResult('configResult', `‚ö†Ô∏è Konnte User Pool nicht pr√ºfen: ${error.message}`, 'error');
                }
            }
        }

        async function testUserStatus() {
            clearResult('userStatusResult');
            const email = document.getElementById('testEmail').value;
            
            if (!email) {
                addResult('userStatusResult', '‚ùå Bitte E-Mail-Adresse eingeben', 'error');
                return;
            }
            
            addResult('userStatusResult', `üîÑ Pr√ºfe Benutzer-Status f√ºr: ${email}...`, 'info');
            
            if (!window.realUserAuth || !window.realUserAuth.isInitialized) {
                addResult('userStatusResult', '‚ùå Auth-System nicht initialisiert', 'error');
                return;
            }
            
            try {
                const cognito = window.realUserAuth.cognitoIdentityServiceProvider;
                const params = {
                    UserPoolId: window.AWS_CONFIG.userPoolId,
                    Username: email
                };
                
                try {
                    const result = await cognito.adminGetUser(params).promise();
                    addResult('userStatusResult', '‚úÖ Benutzer gefunden!', 'success');
                    addResult('userStatusResult', `Status: ${result.UserStatus}`, 'info');
                    addResult('userStatusResult', `E-Mail best√§tigt: ${result.UserAttributes.find(a => a.Name === 'email_verified')?.Value || 'Unbekannt'}`, 'info');
                    addResult('userStatusResult', `<pre>${JSON.stringify(result, null, 2)}</pre>`, 'info');
                } catch (error) {
                    if (error.code === 'UserNotFoundException') {
                        addResult('userStatusResult', `‚ùå Benutzer nicht gefunden: ${error.message}`, 'error');
                        addResult('userStatusResult', 'üí° Benutzer muss registriert werden', 'info');
                    } else {
                        addResult('userStatusResult', `‚ùå Fehler: ${error.message} (Code: ${error.code})`, 'error');
                    }
                }
            } catch (error) {
                addResult('userStatusResult', `‚ùå Fehler beim Pr√ºfen: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            clearResult('loginResult');
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                addResult('loginResult', '‚ùå Bitte E-Mail und Passwort eingeben', 'error');
                return;
            }
            
            addResult('loginResult', `üîÑ Teste Login f√ºr: ${email}...`, 'info');
            
            if (!window.realUserAuth || !window.realUserAuth.isInitialized) {
                addResult('loginResult', '‚ùå Auth-System nicht initialisiert', 'error');
                return;
            }
            
            try {
                const result = await window.realUserAuth.loginWithCognito(email, password);
                
                if (result.success) {
                    addResult('loginResult', '‚úÖ Login erfolgreich!', 'success');
                    addResult('loginResult', `Benutzer: ${result.user.email}`, 'info');
                    addResult('loginResult', `ID: ${result.user.id}`, 'info');
                } else {
                    addResult('loginResult', `‚ùå Login fehlgeschlagen: ${result.error}`, 'error');
                }
            } catch (error) {
                addResult('loginResult', `‚ùå Fehler beim Login: ${error.message}`, 'error');
                if (error.code) {
                    addResult('loginResult', `Fehler-Code: ${error.code}`, 'error');
                }
            }
        }

        function testSession() {
            clearResult('sessionResult');
            
            const session = localStorage.getItem('aws_auth_session');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    addResult('sessionResult', '‚úÖ Session gefunden', 'success');
                    addResult('sessionResult', `E-Mail: ${sessionData.email || 'Nicht verf√ºgbar'}`, 'info');
                    addResult('sessionResult', `Ablauf: ${sessionData.expiresAt || 'Nicht verf√ºgbar'}`, 'info');
                    addResult('sessionResult', `<pre>${JSON.stringify(sessionData, null, 2)}</pre>`, 'info');
                } catch (error) {
                    addResult('sessionResult', `‚ùå Fehler beim Parsen der Session: ${error.message}`, 'error');
                }
            } else {
                addResult('sessionResult', '‚ÑπÔ∏è Keine Session gefunden', 'info');
            }
            
            if (window.realUserAuth) {
                addResult('sessionResult', `Angemeldet: ${window.realUserAuth.isLoggedIn() ? 'Ja' : 'Nein'}`, 'info');
                const user = window.realUserAuth.getCurrentUser();
                if (user) {
                    addResult('sessionResult', `Aktueller Benutzer: ${user.email}`, 'info');
                }
            }
        }

        async function runFullTest() {
            clearResult('fullTestResult');
            addResult('fullTestResult', 'üîÑ F√ºhre vollst√§ndigen Test aus...', 'info');
            
            // Warte auf Initialisierung
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Test 1: System-Initialisierung
            addResult('fullTestResult', '<h3>1. System-Initialisierung</h3>', 'info');
            await testSystemInit();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 2: AWS Config
            addResult('fullTestResult', '<h3>2. AWS Konfiguration</h3>', 'info');
            await testAWSConfig();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 3: Benutzer-Status
            addResult('fullTestResult', '<h3>3. Benutzer-Status</h3>', 'info');
            await testUserStatus();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 4: Session
            addResult('fullTestResult', '<h3>4. Session</h3>', 'info');
            testSession();
            
            addResult('fullTestResult', '<br><strong>‚úÖ Vollst√§ndiger Test abgeschlossen</strong>', 'success');
        }

        // Auto-Test beim Laden
        window.addEventListener('load', () => {
            setTimeout(() => {
                testSystemInit();
            }, 1000);
        });
    </script>
</body>
</html>

