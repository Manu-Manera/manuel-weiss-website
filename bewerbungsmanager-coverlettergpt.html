<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoverLetterGPT - Intelligentes Bewerbungsmanagement</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Chakra UI f√ºr echte CoverLetterGPT Integration -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@chakra-ui/react@2.8.2/dist/chakra-ui.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        
        .header p {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 2rem;
        }
        
        .workflow-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            background: #f0f0f0;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .step.completed {
            background: #10b981;
            color: white;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-textarea {
            min-height: 200px;
            resize: vertical;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .results h3 {
            color: #1f2937;
            margin-bottom: 1rem;
        }
        
        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .keyword {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.875rem;
        }
        
        .analysis-section {
            margin-bottom: 1.5rem;
        }
        
        .analysis-section h3 {
            color: #1f2937;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .analysis-section ul {
            list-style: none;
            padding: 0;
        }
        
        .analysis-section li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .analysis-section li:last-child {
            border-bottom: none;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        
        .api-status {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .api-status.success {
            background: #f0fdf4;
            border-color: #22c55e;
        }
        
        .api-status.error {
            background: #fef2f2;
            border-color: #ef4444;
        }
        
        .api-status h4 {
            color: #0c4a6e;
            margin-bottom: 0.5rem;
        }
        
        .api-status.success h4 {
            color: #166534;
        }
        
        .api-status.error h4 {
            color: #991b1b;
        }
        
        .admin-link {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }
        
        .admin-link a {
            color: #92400e;
            text-decoration: none;
            font-weight: 600;
        }
        
        .admin-link a:hover {
            text-decoration: underline;
        }
        
        .coverlettergpt-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .coverlettergpt-info h4 {
            color: #0c4a6e;
            margin-bottom: 0.5rem;
        }
        
        .coverlettergpt-info p {
            color: #0369a1;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> CoverLetterGPT - NEUE VERSION</h1>
            <p>Intelligentes Bewerbungsmanagement mit KI-Integration - Basierend auf dem originalen CoverLetterGPT Repository</p>
        </div>
        
        <div class="workflow-container">
            <!-- CoverLetterGPT Info -->
            <div class="coverlettergpt-info">
                <h4><i class="fas fa-info-circle"></i> Original CoverLetterGPT Integration</h4>
                <p>Diese Version basiert auf dem originalen CoverLetterGPT Repository von vincanger/coverlettergpt und nutzt die gleichen KI-Prompts und Architektur-Patterns.</p>
            </div>
            
            <!-- API Status -->
            <div class="api-status" id="apiStatus">
                <h4><i class="fas fa-info-circle"></i> API Status</h4>
                <p id="apiStatusText">Lade API Key aus Admin Panel...</p>
            </div>
            
            <!-- Admin Panel Link -->
            <div class="admin-link">
                <p><i class="fas fa-cog"></i> <a href="https://mawps.netlify.app/admin.html" target="_blank">Admin Panel √∂ffnen</a> um OpenAI API Key zu konfigurieren</p>
            </div>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <i class="fas fa-search"></i>
                    <span>Job-Analyse</span>
                </div>
                <div class="step" data-step="2">
                    <i class="fas fa-user-check"></i>
                    <span>Skills-Matching</span>
                </div>
                <div class="step" data-step="3">
                    <i class="fas fa-file-alt"></i>
                    <span>Anschreiben</span>
                </div>
                <div class="step" data-step="4">
                    <i class="fas fa-edit"></i>
                    <span>Optimierung</span>
                </div>
                <div class="step" data-step="5">
                    <i class="fas fa-download"></i>
                    <span>Export</span>
                </div>
            </div>
            
            <!-- Step 1: Job Analysis -->
            <div class="step-content active" id="step1">
                <h2><i class="fas fa-search"></i> Stellenausschreibung analysieren</h2>
                <p>F√ºgen Sie die Stellenausschreibung ein und lassen Sie unsere KI eine detaillierte Analyse durchf√ºhren.</p>
                
                <div class="form-group">
                    <label class="form-label">Unternehmen</label>
                    <input type="text" class="form-input" id="company" placeholder="z.B. Google, Microsoft, Startup XYZ">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Position</label>
                    <input type="text" class="form-input" id="position" placeholder="z.B. Frontend Developer, Product Manager">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stellenausschreibung</label>
                    <textarea class="form-textarea" id="jobDescription" placeholder="F√ºgen Sie hier die komplette Stellenausschreibung ein..."></textarea>
                </div>
                
                <button class="btn btn-primary" id="analyzeBtn">
                    <i class="fas fa-robot"></i>
                    KI-Analyse starten
                </button>
                
                <div class="loading" id="analysisLoading">
                    <div class="spinner"></div>
                    <p>KI analysiert Stellenausschreibung...</p>
                </div>
                
                <div class="results" id="analysisResults" style="display: none;">
                    <h3><i class="fas fa-robot"></i> KI-Analyse Ergebnisse</h3>
                    <div id="analysisContent">
                        <!-- Analysis content will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Skills Matching -->
            <div class="step-content" id="step2">
                <h2><i class="fas fa-user-check"></i> Skills-Matching</h2>
                <p>Geben Sie Ihre Skills ein und lassen Sie die KI den Matching-Score berechnen.</p>
                
                <div class="form-group">
                    <label class="form-label">Ihre Skills (kommagetrennt)</label>
                    <textarea class="form-textarea" id="userSkills" placeholder="z.B. JavaScript, React, Node.js, Python, Projektmanagement, Teamarbeit"></textarea>
                </div>
                
                <button class="btn btn-primary" id="matchingBtn">
                    <i class="fas fa-calculator"></i>
                    Matching berechnen
                </button>
                
                <div class="results" id="matchingResults" style="display: none;">
                    <h3><i class="fas fa-chart-line"></i> Matching-Ergebnisse</h3>
                    <div id="matchingContent">
                        <!-- Matching content will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Cover Letter Generation -->
            <div class="step-content" id="step3">
                <h2><i class="fas fa-file-alt"></i> Anschreiben generieren</h2>
                <p>Lassen Sie die KI ein personalisiertes Anschreiben basierend auf der Analyse erstellen.</p>
                
                <button class="btn btn-primary" id="generateBtn">
                    <i class="fas fa-magic"></i>
                    Anschreiben generieren
                </button>
                
                <div class="loading" id="letterLoading">
                    <div class="spinner"></div>
                    <p>KI generiert personalisiertes Anschreiben...</p>
                </div>
                
                <div class="results" id="coverLetterPreview" style="display: none;">
                    <h3><i class="fas fa-file-alt"></i> Generiertes Anschreiben</h3>
                    <textarea class="form-textarea" id="coverLetterContent" placeholder="Generiertes Anschreiben wird hier angezeigt..."></textarea>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary" id="editBtn">
                            <i class="fas fa-edit"></i>
                            Bearbeiten
                        </button>
                        <button class="btn btn-secondary" id="copyBtn">
                            <i class="fas fa-copy"></i>
                            Kopieren
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Optimization -->
            <div class="step-content" id="step4">
                <h2><i class="fas fa-edit"></i> Optimierung</h2>
                <p>Optimieren Sie Ihr Anschreiben und bereiten Sie sich auf das Interview vor.</p>
                
                <div class="form-group">
                    <label class="form-label">Lebenslauf (optional f√ºr ATS-Optimierung)</label>
                    <textarea class="form-textarea" id="cvContent" placeholder="F√ºgen Sie hier Ihren Lebenslauf ein f√ºr ATS-Optimierung..."></textarea>
                </div>
                
                <button class="btn btn-primary" id="optimizeBtn">
                    <i class="fas fa-cogs"></i>
                    CV optimieren
                </button>
                
                <button class="btn btn-secondary" id="interviewBtn">
                    <i class="fas fa-question-circle"></i>
                    Interview-Fragen generieren
                </button>
                
                <div class="results" id="optimizationResults" style="display: none;">
                    <h3><i class="fas fa-chart-line"></i> Optimierungs-Ergebnisse</h3>
                    <div id="optimizationContent">
                        <!-- Optimization content will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Export -->
            <div class="step-content" id="step5">
                <h2><i class="fas fa-download"></i> Export & Finalisierung</h2>
                <p>Exportieren Sie Ihre Bewerbungsunterlagen in verschiedenen Formaten.</p>
                
                <div class="results">
                    <h3><i class="fas fa-file-export"></i> Export-Optionen</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="exportPdfBtn">
                            <i class="fas fa-file-pdf"></i>
                            PDF exportieren
                        </button>
                        <button class="btn btn-primary" id="exportDocxBtn">
                            <i class="fas fa-file-word"></i>
                            DOCX exportieren
                        </button>
                        <button class="btn btn-secondary" id="exportZipBtn">
                            <i class="fas fa-file-archive"></i>
                            ZIP-Paket
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="navigation">
                <button class="btn btn-secondary" id="prevBtn" disabled>
                    <i class="fas fa-arrow-left"></i>
                    Zur√ºck
                </button>
                <button class="btn btn-primary" id="nextBtn">
                    Weiter
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Original CoverLetterGPT Integration basierend auf dem Fork
        class CoverLetterGPTFork {
            constructor() {
                this.currentStep = 1;
                this.workflowData = {
                    company: '',
                    position: '',
                    jobDescription: '',
                    analysis: null,
                    userSkills: '',
                    matchingScore: 0,
                    coverLetter: '',
                    cvContent: ''
                };
                this.apiKey = null;
                this.init();
            }
            
            async init() {
                console.log('üöÄ CoverLetterGPT Fork Integration initialisiert');
                
                // Lade API Key aus Admin Panel
                await this.loadAPIKeyFromAdminPanel();
                
                this.setupEventListeners();
                this.updateStepIndicator();
                this.updateAPIStatus();
            }
            
            async loadAPIKeyFromAdminPanel() {
                try {
                    // Versuche API Key aus localStorage zu laden (wird vom Admin Panel gesetzt)
                    const apiKey = localStorage.getItem('openai_api_key');
                    
                    if (apiKey && apiKey.startsWith('sk-')) {
                        this.apiKey = apiKey;
                        console.log('‚úÖ OpenAI API Key aus Admin Panel geladen');
                        return true;
                    }
                    
                    // Fallback: Versuche aus sessionStorage
                    const sessionKey = sessionStorage.getItem('openai_api_key');
                    if (sessionKey && sessionKey.startsWith('sk-')) {
                        this.apiKey = sessionKey;
                        console.log('‚úÖ OpenAI API Key aus Session geladen');
                        return true;
                    }
                    
                    console.warn('‚ö†Ô∏è Kein OpenAI API Key im Admin Panel konfiguriert');
                    return false;
                    
                } catch (error) {
                    console.error('Fehler beim Laden des API Keys:', error);
                    return false;
                }
            }
            
            updateAPIStatus() {
                const statusDiv = document.getElementById('apiStatus');
                const statusText = document.getElementById('apiStatusText');
                
                if (this.apiKey) {
                    statusDiv.className = 'api-status success';
                    statusDiv.innerHTML = `
                        <h4><i class="fas fa-check-circle"></i> API Status: Verbunden</h4>
                        <p>OpenAI API Key erfolgreich geladen. KI-Funktionen sind verf√ºgbar.</p>
                    `;
                } else {
                    statusDiv.className = 'api-status error';
                    statusDiv.innerHTML = `
                        <h4><i class="fas fa-exclamation-triangle"></i> API Status: Nicht konfiguriert</h4>
                        <p>Bitte konfigurieren Sie den OpenAI API Key im Admin Panel.</p>
                    `;
                }
            }
            
            setupEventListeners() {
                // Navigation
                document.getElementById('prevBtn').addEventListener('click', () => this.previousStep());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextStep());
                
                // Step 1: Job Analysis
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyzeJob());
                
                // Step 2: Skills Matching
                document.getElementById('matchingBtn').addEventListener('click', () => this.calculateMatching());
                
                // Step 3: Cover Letter Generation
                document.getElementById('generateBtn').addEventListener('click', () => this.generateCoverLetter());
                
                // Step 4: Optimization
                document.getElementById('optimizeBtn').addEventListener('click', () => this.optimizeCV());
                document.getElementById('interviewBtn').addEventListener('click', () => this.generateInterviewQuestions());
                
                // Step 5: Export
                document.getElementById('exportPdfBtn').addEventListener('click', () => this.exportPDF());
                document.getElementById('exportDocxBtn').addEventListener('click', () => this.exportDOCX());
                document.getElementById('exportZipBtn').addEventListener('click', () => this.exportZIP());
                
                // Copy functionality
                document.getElementById('copyBtn').addEventListener('click', () => this.copyCoverLetter());
            }
            
            updateStepIndicator() {
                document.querySelectorAll('.step').forEach((step, index) => {
                    const stepNumber = index + 1;
                    step.classList.remove('active', 'completed');
                    
                    if (stepNumber === this.currentStep) {
                        step.classList.add('active');
                    } else if (stepNumber < this.currentStep) {
                        step.classList.add('completed');
                    }
                });
            }
            
            showStep(stepNumber) {
                document.querySelectorAll('.step-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const targetStep = document.getElementById(`step${stepNumber}`);
                if (targetStep) {
                    targetStep.classList.add('active');
                }
                
                this.currentStep = stepNumber;
                this.updateStepIndicator();
                this.updateNavigation();
            }
            
            updateNavigation() {
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                if (prevBtn) prevBtn.disabled = this.currentStep === 1;
                
                if (nextBtn) {
                    if (this.currentStep === 5) {
                        nextBtn.innerHTML = '<i class="fas fa-check"></i> Abschlie√üen';
                        nextBtn.onclick = () => this.completeWorkflow();
                    } else {
                        nextBtn.innerHTML = 'Weiter <i class="fas fa-arrow-right"></i>';
                        nextBtn.onclick = () => this.nextStep();
                    }
                }
            }
            
            nextStep() {
                if (this.currentStep < 5) {
                    this.saveCurrentStepData();
                    this.showStep(this.currentStep + 1);
                }
            }
            
            previousStep() {
                if (this.currentStep > 1) {
                    this.showStep(this.currentStep - 1);
                }
            }
            
            saveCurrentStepData() {
                switch(this.currentStep) {
                    case 1:
                        this.workflowData.company = document.getElementById('company').value;
                        this.workflowData.position = document.getElementById('position').value;
                        this.workflowData.jobDescription = document.getElementById('jobDescription').value;
                        break;
                    case 2:
                        this.workflowData.userSkills = document.getElementById('userSkills').value;
                        break;
                    case 3:
                        this.workflowData.coverLetter = document.getElementById('coverLetterContent').value;
                        break;
                    case 4:
                        this.workflowData.cvContent = document.getElementById('cvContent').value;
                        break;
                }
            }
            
            async analyzeJob() {
                if (!this.apiKey) {
                    alert('Bitte konfigurieren Sie zuerst den OpenAI API Key im Admin Panel.');
                    return;
                }
                
                const company = document.getElementById('company').value;
                const position = document.getElementById('position').value;
                const description = document.getElementById('jobDescription').value;
                
                if (!company || !position || !description) {
                    alert('Bitte f√ºllen Sie alle Felder aus.');
                    return;
                }
                
                const loading = document.getElementById('analysisLoading');
                const results = document.getElementById('analysisResults');
                const content = document.getElementById('analysisContent');
                
                if (loading) loading.classList.add('active');
                
                try {
                    console.log('ü§ñ Verwende echte OpenAI API f√ºr KI-Analyse');
                    const analysis = await this.callOpenAIForAnalysis(description, company, position);
                    
                    this.workflowData.analysis = analysis;
                    
                    if (results && content) {
                        results.style.display = 'block';
                        content.innerHTML = this.formatAnalysisResults(analysis);
                    }
                    
                } catch (error) {
                    console.error('Fehler bei KI-Analyse:', error);
                    alert('Fehler bei der KI-Analyse. Bitte versuchen Sie es erneut.');
                } finally {
                    if (loading) loading.classList.remove('active');
                }
            }
            
            async callOpenAIForAnalysis(description, company, position) {
                // Original CoverLetterGPT Prompts aus dem Fork
                const prompt = `
                    You are a cover letter generator.
                    You will be given a job description along with the job applicant's resume.
                    You will write a cover letter for the applicant that matches their past experiences from the resume with the job description. Write the cover letter in the same language as the job description provided!
                    Rather than simply outlining the applicant's past experiences, you will give more detail and explain how those experiences will help the applicant succeed in the new job.
                    You will write the cover letter in a modern, professional style without being too formal, as a modern employee might do naturally.
                    
                    Analyze this job description and extract:
                    1. Key requirements (at least 5 specific requirements)
                    2. Keywords (at least 10 relevant keywords)
                    3. Desired soft skills (communication, teamwork, etc.)
                    4. Technical requirements (programming languages, tools, etc.)
                    5. Experience level (Junior, Mid-Level, Senior, etc.)
                    6. Industry/Type (IT, Marketing, Finance, etc.)
                    
                    Job: ${position}
                    Company: ${company}
                    Description: ${description}
                    
                    Respond in JSON format with detailed analysis.
                `;
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert in job applications and career counseling. Analyze job descriptions precisely and structured.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`OpenAI API Fehler: ${response.status}`);
                }
                
                const data = await response.json();
                return JSON.parse(data.choices[0].message.content);
            }
            
            formatAnalysisResults(analysis) {
                return `
                    <div class="analysis-section">
                        <h3><i class="fas fa-list"></i> Hauptanforderungen</h3>
                        <ul>
                            ${analysis.requirements.map(req => `<li>${req}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="analysis-section">
                        <h3><i class="fas fa-tags"></i> Schl√ºsselw√∂rter</h3>
                        <div class="keywords">
                            ${analysis.keywords.map(keyword => `<span class="keyword">${keyword}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h3><i class="fas fa-users"></i> Soft Skills</h3>
                        <ul>
                            ${analysis.softSkills.map(skill => `<li>${skill}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="analysis-section">
                        <h3><i class="fas fa-code"></i> Technische Skills</h3>
                        <ul>
                            ${analysis.technicalSkills.map(skill => `<li>${skill}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="analysis-section">
                        <h3><i class="fas fa-chart-line"></i> Zusammenfassung</h3>
                        <p>${analysis.summary}</p>
                    </div>
                `;
            }
            
            async calculateMatching() {
                if (!this.apiKey) {
                    alert('Bitte konfigurieren Sie zuerst den OpenAI API Key im Admin Panel.');
                    return;
                }
                
                const userSkills = document.getElementById('userSkills').value;
                
                if (!userSkills) {
                    alert('Bitte geben Sie Ihre Skills ein.');
                    return;
                }
                
                if (!this.workflowData.analysis) {
                    alert('Bitte f√ºhren Sie zuerst eine Stellenanalyse durch.');
                    return;
                }
                
                try {
                    const matching = await this.callOpenAIForMatching(userSkills, this.workflowData.analysis);
                    
                    this.workflowData.matchingScore = matching.score;
                    
                    const results = document.getElementById('matchingResults');
                    const content = document.getElementById('matchingContent');
                    
                    if (results) results.style.display = 'block';
                    if (content) content.innerHTML = this.formatMatchingResults(matching);
                    
                } catch (error) {
                    console.error('Fehler bei Skill-Matching:', error);
                    alert('Fehler bei der Matching-Berechnung. Bitte versuchen Sie es erneut.');
                }
            }
            
            async callOpenAIForMatching(userSkills, jobRequirements) {
                const prompt = `
                    Calculate a matching score between user skills and job requirements:
                    
                    User Skills: ${userSkills}
                    Job Requirements: ${JSON.stringify(jobRequirements)}
                    
                    Calculate a score from 0-100% and return a detailed analysis.
                    
                    Respond in JSON format:
                    {
                        "score": 85,
                        "matchedSkills": ["Skill 1", "Skill 2"],
                        "missingSkills": ["Missing Skill 1", "Missing Skill 2"],
                        "recommendations": ["Recommendation 1", "Recommendation 2"],
                        "analysis": "Detailed analysis of the matching"
                    }
                `;
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert in job applications and career counseling.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`OpenAI API Fehler: ${response.status}`);
                }
                
                const data = await response.json();
                return JSON.parse(data.choices[0].message.content);
            }
            
            formatMatchingResults(matching) {
                return `
                    <div class="analysis-section">
                        <h3><i class="fas fa-chart-line"></i> Matching-Score: ${matching.score}%</h3>
                        <div style="background: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); height: 100%; width: ${matching.score}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h3><i class="fas fa-check-circle"></i> Passende Skills</h3>
                        <ul>
                            ${matching.matchedSkills.map(skill => `<li>${skill}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="analysis-section">
                        <h3><i class="fas fa-exclamation-circle"></i> Fehlende Skills</h3>
                        <ul>
                            ${matching.missingSkills.map(skill => `<li>${skill}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="analysis-section">
                        <h3><i class="fas fa-lightbulb"></i> Empfehlungen</h3>
                        <ul>
                            ${matching.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            async generateCoverLetter() {
                if (!this.apiKey) {
                    alert('Bitte konfigurieren Sie zuerst den OpenAI API Key im Admin Panel.');
                    return;
                }
                
                if (!this.workflowData.analysis) {
                    alert('Bitte f√ºhren Sie zuerst eine Stellenanalyse durch.');
                    return;
                }
                
                const loading = document.getElementById('letterLoading');
                const preview = document.getElementById('coverLetterPreview');
                const content = document.getElementById('coverLetterContent');
                
                if (loading) loading.classList.add('active');
                
                try {
                    console.log('ü§ñ Verwende echte OpenAI API f√ºr Anschreiben-Generierung');
                    const coverLetter = await this.callOpenAIForCoverLetter();
                    
                    this.workflowData.coverLetter = coverLetter;
                    
                    if (preview) preview.style.display = 'block';
                    if (content) content.value = coverLetter;
                    
                } catch (error) {
                    console.error('Fehler bei Anschreiben-Generierung:', error);
                    alert('Fehler bei der Anschreiben-Generierung. Bitte versuchen Sie es erneut.');
                } finally {
                    if (loading) loading.classList.remove('active');
                }
            }
            
            async callOpenAIForCoverLetter() {
                // Original CoverLetterGPT Prompts aus dem Fork
                const prompt = `
                    You are a cover letter generator.
                    You will be given a job description along with the job applicant's resume.
                    You will write a cover letter for the applicant that matches their past experiences from the resume with the job description. Write the cover letter in the same language as the job description provided!
                    Rather than simply outlining the applicant's past experiences, you will give more detail and explain how those experiences will help the applicant succeed in the new job.
                    You will write the cover letter in a modern, professional style without being too formal, as a modern employee might do naturally.
                    
                    Create a professional, personalized cover letter for:
                    
                    Company: ${this.workflowData.company}
                    Position: ${this.workflowData.position}
                    Job Description: ${this.workflowData.jobDescription}
                    User Skills: ${this.workflowData.userSkills}
                    Job Analysis: ${JSON.stringify(this.workflowData.analysis)}
                    
                    The cover letter should:
                    - Be professional and convincing
                    - Specifically address the position
                    - Highlight the applicant's relevant skills
                    - Have a clear structure (greeting, introduction, main part, conclusion)
                    - Be maximum 300 words long
                    - Be written in German
                    
                    Create a complete cover letter:
                `;
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert in job applications and career counseling. Create professional, convincing application documents.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`OpenAI API Fehler: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            async optimizeCV() {
                if (!this.apiKey) {
                    alert('Bitte konfigurieren Sie zuerst den OpenAI API Key im Admin Panel.');
                    return;
                }
                
                const cvContent = document.getElementById('cvContent').value;
                
                if (!cvContent) {
                    alert('Bitte geben Sie Ihren Lebenslauf ein.');
                    return;
                }
                
                if (!this.workflowData.analysis) {
                    alert('Bitte f√ºhren Sie zuerst eine Stellenanalyse durch.');
                    return;
                }
                
                try {
                    const optimizedCV = await this.callOpenAIForCVOptimization(cvContent, this.workflowData.analysis);
                    
                    document.getElementById('cvContent').value = optimizedCV;
                    alert('‚úÖ Lebenslauf erfolgreich optimiert!');
                    
                } catch (error) {
                    console.error('Fehler bei CV-Optimierung:', error);
                    alert('Fehler bei der CV-Optimierung. Bitte versuchen Sie es erneut.');
                }
            }
            
            async callOpenAIForCVOptimization(cvContent, jobRequirements) {
                const prompt = `
                    Optimize the following CV for the job requirements:
                    
                    CV:
                    ${cvContent}
                    
                    Job Requirements:
                    ${JSON.stringify(jobRequirements)}
                    
                    Optimize:
                    1. Keywords for ATS systems
                    2. Structure and formatting
                    3. Highlight relevant experience
                    4. Add missing important points
                    
                    Return the optimized CV:
                `;
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert in job applications and career counseling.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`OpenAI API Fehler: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            async generateInterviewQuestions() {
                if (!this.apiKey) {
                    alert('Bitte konfigurieren Sie zuerst den OpenAI API Key im Admin Panel.');
                    return;
                }
                
                if (!this.workflowData.analysis) {
                    alert('Bitte f√ºhren Sie zuerst eine Stellenanalyse durch.');
                    return;
                }
                
                try {
                    const prompt = `
                        Generate 5 typical interview questions for the position "${this.workflowData.position}" at the company "${this.workflowData.company}" based on the job description: ${this.workflowData.jobDescription}.
                    `;
                    
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are an expert in job applications and career counseling.'
                                },
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ],
                            max_tokens: 1000,
                            temperature: 0.7
                        })
                    });
                    
                    const data = await response.json();
                    const questions = data.choices[0].message.content;
                    
                    const results = document.getElementById('optimizationResults');
                    const content = document.getElementById('optimizationContent');
                    
                    if (results) results.style.display = 'block';
                    if (content) content.innerHTML = `
                        <div class="analysis-section">
                            <h3><i class="fas fa-question-circle"></i> Interview-Fragen</h3>
                            <div style="white-space: pre-line;">${questions}</div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Fehler bei Interview-Fragen:', error);
                    alert('Fehler bei der Generierung der Interview-Fragen. Bitte versuchen Sie es erneut.');
                }
            }
            
            copyCoverLetter() {
                const content = document.getElementById('coverLetterContent').value;
                navigator.clipboard.writeText(content).then(() => {
                    alert('‚úÖ Anschreiben in die Zwischenablage kopiert!');
                });
            }
            
            exportPDF() {
                alert('PDF-Export wird implementiert...');
            }
            
            exportDOCX() {
                alert('DOCX-Export wird implementiert...');
            }
            
            exportZIP() {
                alert('ZIP-Export wird implementiert...');
            }
            
            completeWorkflow() {
                alert('üéâ Bewerbung erfolgreich abgeschlossen!');
                console.log('Final workflow data:', this.workflowData);
            }
        }
        
        // Initialize CoverLetterGPT Fork
        document.addEventListener('DOMContentLoaded', () => {
            window.coverLetterGPTFork = new CoverLetterGPTFork();
        });
    </script>
</body>
</html>