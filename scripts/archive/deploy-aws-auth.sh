#!/bin/bash

# AWS Cognito Authentication Deployment Script
# Dieses Script deployt die AWS-Infrastruktur fÃ¼r die Authentifizierung

set -e

echo "ðŸš€ Starting AWS Cognito Authentication Deployment..."

# PrÃ¼fen ob AWS CLI installiert ist
if ! command -v aws &> /dev/null; then
    echo "âŒ AWS CLI ist nicht installiert. Bitte installieren Sie AWS CLI."
    exit 1
fi

# PrÃ¼fen ob CDK installiert ist
if ! command -v cdk &> /dev/null; then
    echo "âŒ AWS CDK ist nicht installiert. Bitte installieren Sie AWS CDK."
    exit 1
fi

# AWS Credentials prÃ¼fen
echo "ðŸ” Checking AWS credentials..."
if ! aws sts get-caller-identity &> /dev/null; then
    echo "âŒ AWS Credentials nicht konfiguriert. Bitte fÃ¼hren Sie 'aws configure' aus."
    exit 1
fi

echo "âœ… AWS Credentials gefunden"

# CDK Bootstrap prÃ¼fen
echo "ðŸ“¦ Checking CDK Bootstrap..."
if ! aws cloudformation describe-stacks --stack-name CDKToolkit &> /dev/null; then
    echo "ðŸ”§ CDK Bootstrap wird durchgefÃ¼hrt..."
    cdk bootstrap
fi

# Dependencies installieren
echo "ðŸ“¦ Installing dependencies..."
npm install

# CDK Stack deployen
echo "ðŸš€ Deploying CDK Stack..."
cdk deploy --require-approval never

# Stack Outputs abrufen
echo "ðŸ“‹ Retrieving stack outputs..."
STACK_NAME="ManuelWeissWebsiteStack"
USER_POOL_ID=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' --output text)
USER_POOL_CLIENT_ID=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' --output text)
REGION=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].Outputs[?OutputKey==`Region`].OutputValue' --output text)

echo "âœ… Deployment erfolgreich!"
echo ""
echo "ðŸ“‹ AWS Cognito Configuration:"
echo "User Pool ID: $USER_POOL_ID"
echo "User Pool Client ID: $USER_POOL_CLIENT_ID"
echo "Region: $REGION"
echo ""

# Konfigurationsdatei erstellen
echo "ðŸ“ Creating configuration file..."
cat > aws-cognito-config.js << EOF
// AWS Cognito Configuration
// Automatically generated by deployment script

window.AWS_COGNITO_CONFIG = {
    userPoolId: '$USER_POOL_ID',
    clientId: '$USER_POOL_CLIENT_ID',
    region: '$REGION'
};

// Update aws-auth.js with actual values
if (typeof window.awsAuth !== 'undefined') {
    window.awsAuth.userPoolId = '$USER_POOL_ID';
    window.awsAuth.clientId = '$USER_POOL_CLIENT_ID';
    window.awsAuth.region = '$REGION';
}
EOF

echo "ðŸ“ Configuration file created: aws-cognito-config.js"
echo ""

# Test-User erstellen (optional)
read -p "ðŸ¤” MÃ¶chten Sie einen Test-User erstellen? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ðŸ‘¤ Creating test user..."
    read -p "E-Mail fÃ¼r Test-User: " TEST_EMAIL
    read -p "Passwort fÃ¼r Test-User: " -s TEST_PASSWORD
    echo
    
    aws cognito-idp admin-create-user \
        --user-pool-id $USER_POOL_ID \
        --username $TEST_EMAIL \
        --user-attributes Name=email,Value=$TEST_EMAIL Name=email_verified,Value=true \
        --temporary-password $TEST_PASSWORD \
        --message-action SUPPRESS
    
    echo "âœ… Test-User erstellt: $TEST_EMAIL"
    echo "ðŸ”‘ TemporÃ¤res Passwort: $TEST_PASSWORD"
fi

echo ""
echo "ðŸŽ‰ AWS Cognito Authentication Setup abgeschlossen!"
echo ""
echo "ðŸ“š NÃ¤chste Schritte:"
echo "1. FÃ¼gen Sie aws-cognito-config.js zu Ihren HTML-Seiten hinzu"
echo "2. Testen Sie die Anmeldung auf der Website"
echo "3. Konfigurieren Sie E-Mail-Versand fÃ¼r Produktionsumgebung"
echo ""
echo "ðŸ”— NÃ¼tzliche Links:"
echo "- AWS Cognito Console: https://console.aws.amazon.com/cognito/"
echo "- CloudFormation Console: https://console.aws.amazon.com/cloudformation/"
echo ""
