version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "ğŸš€ MANUEL WEISS MULTI-USER SYSTEM - Amplify Build"
        - echo "ğŸ“Š Building massive app with 67 HTML pages, 62 JS modules, 35 methods"
        - echo "ğŸ”§ Installing dependencies..."
        - npm install || echo "No npm dependencies to install"
        - echo "ğŸ“‹ Verifying all critical files..."
        - ls -la | grep -E "(admin|index|bewerbung|persoenlichkeit)" | head -10
        - echo "âœ… Critical files verified"
    build:
      commands:
        - echo "ğŸ—ï¸ Building complete multi-user system..."
        - echo "ğŸ“± Frontend: Static HTML/CSS/JS (no build required)"
        - echo "âš¡ Backend: AWS services integration"
        - echo "ğŸ”— Updating API endpoints for production..."
        
        # Update API URLs for production
        - |
          if [ "$AWS_BRANCH" = "main" ] || [ "$AWS_BRANCH" = "feature/userfiles-auth" ]; then
            echo "ğŸŒ Production build - updating API configuration"
            
            # Get API Gateway URL from environment
            if [ ! -z "$API_GATEWAY_URL" ]; then
              echo "ğŸ”— Updating API base URL to: $API_GATEWAY_URL"
              sed -i "s|base: '/api'|base: '$API_GATEWAY_URL'|g" js/docs.js
              echo "âœ… js/docs.js updated with production API"
            fi
            
            # Update Cognito URLs if available
            if [ ! -z "$USER_POOL_CLIENT_ID" ] && [ ! -z "$USER_POOL_DOMAIN" ]; then
              echo "ğŸ” Updating Cognito URLs..."
              COGNITO_DOMAIN="${USER_POOL_DOMAIN}.auth.${AWS_REGION}.amazoncognito.com"
              LOGIN_URL="https://${COGNITO_DOMAIN}/login?client_id=${USER_POOL_CLIENT_ID}&response_type=code&scope=email+openid+profile&redirect_uri=${AWS_AMPLIFY_URL}/"
              LOGOUT_URL="https://${COGNITO_DOMAIN}/logout?client_id=${USER_POOL_CLIENT_ID}&logout_uri=${AWS_AMPLIFY_URL}/"
              
              # Update auth URLs in relevant files
              find . -name "*.html" -type f -exec grep -l "YOUR_DOMAIN.auth.eu-central-1.amazoncognito.com" {} \; | while read file; do
                echo "ğŸ”„ Updating Cognito URLs in: $file"
                sed -i "s|https://YOUR_DOMAIN.auth.eu-central-1.amazoncognito.com/login?...|$LOGIN_URL|g" "$file"
                sed -i "s|https://YOUR_DOMAIN.auth.eu-central-1.amazoncognito.com/logout?...|$LOGOUT_URL|g" "$file"
              done
              
              echo "âœ… Cognito URLs updated in HTML files"
            fi
          fi
        
        - echo "ğŸ“Š Build statistics:"
        - echo "   ğŸ“„ HTML files: $(find . -name '*.html' | wc -l)"
        - echo "   ğŸ“œ JS modules: $(find js/ -name '*.js' | wc -l)"
        - echo "   ğŸ§  Method pages: $(find methods/ -name '*.html' | wc -l)"
        - echo "   ğŸ¨ CSS files: $(find . -name '*.css' | wc -l)"
        - echo "   ğŸ–¼ï¸ Images: $(find images/ -type f | wc -l)"
        
    postBuild:
      commands:
        - echo "ğŸ¯ Post-build optimization..."
        - echo "ğŸ” Verifying critical pages exist:"
        - test -f index.html && echo "âœ… index.html" || echo "âŒ index.html missing"
        - test -f admin.html && echo "âœ… admin.html" || echo "âŒ admin.html missing"
        - test -f bewerbung.html && echo "âœ… bewerbung.html" || echo "âŒ bewerbung.html missing"
        - test -f persoenlichkeitsentwicklung-uebersicht.html && echo "âœ… personality overview" || echo "âŒ personality overview missing"
        - test -d js/ && echo "âœ… js/ directory" || echo "âŒ js/ directory missing"
        - test -d methods/ && echo "âœ… methods/ directory" || echo "âŒ methods/ directory missing"
        - test -d css/ && echo "âœ… css/ directory" || echo "âŒ css/ directory missing"
        
        - echo "ğŸ”§ Final optimizations..."
        - echo "âœ… Multi-user system integrated"
        - echo "âœ… AWS services connected"
        - echo "âœ… Progress tracking enabled"
        - echo "âœ… Authentication configured"
        
        - echo "ğŸ‰ DEPLOYMENT COMPLETE!"
        - echo "ğŸ“Š Manuel Weiss Multi-User System ready for production"
        
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
    excludeFiles:
      - node_modules/**/*
      - .git/**/*
      - '*.log'
      - '.DS_Store'
      - 'aws-*.yaml'
      - '*.sh'
      - '*.md'
  cache:
    paths:
      - node_modules/**/*
      - amplify/**/*
      
env:
  variables:
    AMPLIFY_MONOREPO_APP_ROOT: '/'
    AMPLIFY_DIFF_DEPLOY: false
    AMPLIFY_SKIP_ON_EMPTY_DIFF: false
