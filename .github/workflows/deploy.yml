name: ğŸš€ Deploy Manuel Weiss Website

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "ğŸ”§ Installing dependencies..."
        npm install || echo "No package.json found, continuing..."
        
    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª Running basic tests..."
        # Test if critical files exist
        test -f index.html && echo "âœ… index.html exists" || echo "âŒ index.html missing"
        test -f admin.html && echo "âœ… admin.html exists" || echo "âŒ admin.html missing"
        test -f bewerbung.html && echo "âœ… bewerbung.html exists" || echo "âŒ bewerbung.html missing"
        test -d js/ && echo "âœ… js/ directory exists" || echo "âŒ js/ directory missing"
        test -d css/ && echo "âœ… css/ directory exists" || echo "âŒ css/ directory missing"
        
    - name: ğŸ”§ Fix Auth Integration
      run: |
        echo "ğŸ”§ Applying auth fixes..."
        
        # Create unified auth integration
        cat > components/unified-auth-integration.html << 'EOF'
        <!-- ğŸ”§ UNIFIED AUTH INTEGRATION -->
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1490.0.min.js"></script>
        <script src="js/redirect-url-config.js"></script>
        <script src="js/fixed-auth-system.js"></script>
        <script src="js/error-handler.js"></script>
        <script src="js/global-auth-system.js"></script>
        <script src="js/auth-modals.js"></script>
        EOF
        
        # Update HTML files with auth integration
        find . -name "*.html" -not -path "./node_modules/*" -not -path "./.git/*" | while read file; do
          if ! grep -q "UNIFIED AUTH INTEGRATION" "$file"; then
            echo "ğŸ”„ Updating: $file"
            sed -i "s|</body>|$(cat components/unified-auth-integration.html)\n</body>|" "$file"
          fi
        done
        
    - name: ğŸŒ Deploy to Netlify
      uses: nwtgck/actions-netlify@v2.0
      with:
        publish-dir: '.'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "ğŸš€ Deploy from GitHub Actions"
        enable-pull-request-comment: false
        enable-commit-comment: true
        overwrites-pull-request-comment: true
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸ“Š Website Statistics:"
        echo "   ğŸ“„ HTML files: $(find . -name '*.html' | wc -l)"
        echo "   ğŸ“œ JS modules: $(find js/ -name '*.js' | wc -l)"
        echo "   ğŸ§  Method pages: $(find methods/ -name '*.html' | wc -l)"
        echo "   ğŸ¨ CSS files: $(find . -name '*.css' | wc -l)"
        echo "   ğŸ–¼ï¸ Images: $(find images/ -type f | wc -l)"
        echo ""
        echo "ğŸ”— Live URLs:"
        echo "   ğŸŒ Main site: https://mawps.netlify.app"
        echo "   ğŸ”§ Admin panel: https://mawps.netlify.app/admin.html"
        echo "   ğŸ“ Bewerbung: https://mawps.netlify.app/bewerbung.html"
