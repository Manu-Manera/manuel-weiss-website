<div class="section-header">
    <h2>üé¨ Hero-Video Verwaltung</h2>
    <p>Verwalte das Hintergrund-Video auf der Startseite</p>
</div>

<!-- Aktuelles Video Status -->
<div class="current-video-status" id="currentVideoStatus" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
        <i class="fas fa-video" style="font-size: 1.5rem;"></i>
        <div style="flex: 1;">
            <h4 style="margin: 0; font-size: 1.1rem;">Aktuelles Hero-Video</h4>
            <p style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.9rem;" id="currentVideoInfo">Lade Status...</p>
        </div>
    </div>
    <div id="currentVideoPreview" style="margin-top: 1rem;">
        <!-- Video Preview wird hier eingef√ºgt -->
    </div>
</div>

<!-- Upload Section -->
<div class="upload-section" style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
    <h3 style="color: #333; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-cloud-upload-alt"></i>
        Neues Video hochladen
    </h3>
    
    <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
            Video-Datei ausw√§hlen (MP4, max. 100MB)
        </label>
        <input type="file" id="videoFileInput" accept="video/mp4,video/webm" style="width: 100%; padding: 0.75rem; border: 2px dashed #cbd5e1; border-radius: 8px; background: #f8fafc;">
        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #64748b;">
            <i class="fas fa-info-circle"></i> Das Video wird automatisch ohne Ton abgespielt und in Dauerschleife laufen.
        </p>
    </div>

    <!-- Video Preview vor Upload -->
    <div id="videoPreviewContainer" style="display: none; margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Vorschau:</label>
        <video id="videoPreview" controls style="width: 100%; max-width: 600px; border-radius: 8px; background: #000;"></video>
    </div>

    <!-- Upload Progress -->
    <div class="upload-progress" id="uploadProgress" style="display: none; margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
            <i class="fas fa-spinner fa-spin" style="color: #667eea;"></i>
            <span style="font-weight: 600; color: #333;">Upload l√§uft...</span>
        </div>
        <div class="progress-bar" style="background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden;">
            <div class="progress-fill" id="progressFill" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
        </div>
        <div class="progress-text" style="text-align: center; margin-top: 0.5rem; color: #64748b; font-size: 0.9rem;">
            <span id="progress-percentage">0%</span> - <span id="progress-status">Vorbereitung...</span>
        </div>
    </div>

    <!-- Upload Button -->
    <button id="uploadVideoBtn" onclick="uploadVideo()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" disabled>
        <i class="fas fa-upload"></i> Video hochladen und aktivieren
    </button>
</div>

<!-- Erfolgsmeldung -->
<div id="successMessage" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <i class="fas fa-check-circle" style="font-size: 1.5rem;"></i>
        <div>
            <strong>Video erfolgreich hochgeladen!</strong>
            <p style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Das Video wird nun auf der Startseite angezeigt.</p>
        </div>
    </div>
</div>

<script>
// Lade aktuelles Video beim Seitenaufruf
document.addEventListener('DOMContentLoaded', async () => {
    await loadCurrentVideo();
    
    // Video Preview beim Datei-Auswahl
    document.getElementById('videoFileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const preview = document.getElementById('videoPreview');
            const container = document.getElementById('videoPreviewContainer');
            const uploadBtn = document.getElementById('uploadVideoBtn');
            
            preview.src = URL.createObjectURL(file);
            container.style.display = 'block';
            uploadBtn.disabled = false;
        }
    });
});

async function loadCurrentVideo() {
    try {
        const response = await fetch('/.netlify/functions/hero-video-settings');
        const data = await response.json();
        
        const statusDiv = document.getElementById('currentVideoStatus');
        const infoP = document.getElementById('currentVideoInfo');
        const previewDiv = document.getElementById('currentVideoPreview');
        
        if (data.videoUrl) {
            infoP.textContent = `Aktuell aktiv: ${new URL(data.videoUrl).pathname.split('/').pop()}`;
            if (data.updatedAt) {
                infoP.textContent += ` (Aktualisiert: ${new Date(data.updatedAt).toLocaleString('de-DE')})`;
            }
            
            // Video Preview
            previewDiv.innerHTML = `
                <video controls style="width: 100%; max-width: 600px; border-radius: 8px; background: #000;">
                    <source src="${data.videoUrl}" type="video/mp4">
                </video>
            `;
        } else {
            infoP.textContent = 'Kein Video aktiv. Bitte ein Video hochladen.';
            previewDiv.innerHTML = '<p style="opacity: 0.8;">Keine Vorschau verf√ºgbar</p>';
        }
    } catch (error) {
        console.error('Error loading current video:', error);
        document.getElementById('currentVideoInfo').textContent = 'Fehler beim Laden des Status';
    }
}

async function uploadVideo() {
    const fileInput = document.getElementById('videoFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Bitte w√§hle zuerst eine Video-Datei aus.');
        return;
    }
    
    // Validierung
    if (file.size > 100 * 1024 * 1024) { // 100MB
        alert('Die Datei ist zu gro√ü. Maximal 100MB erlaubt.');
        return;
    }
    
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressStatus = document.getElementById('progress-status');
    const uploadBtn = document.getElementById('uploadVideoBtn');
    const successMessage = document.getElementById('successMessage');
    
    uploadProgress.style.display = 'block';
    uploadBtn.disabled = true;
    successMessage.style.display = 'none';
    
    try {
        // Schritt 1: Hole Pre-Signed URL
        progressStatus.textContent = 'Vorbereitung...';
        progressFill.style.width = '10%';
        progressPercentage.textContent = '10%';
        
        const uploadUrlResponse = await fetch('/.netlify/functions/hero-video-upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                fileName: file.name,
                contentType: file.type || 'video/mp4'
            })
        });
        
        if (!uploadUrlResponse.ok) {
            throw new Error('Fehler beim Generieren der Upload-URL');
        }
        
        const { uploadUrl, publicUrl } = await uploadUrlResponse.json();
        
        // Schritt 2: Lade Video direkt zu S3
        progressStatus.textContent = 'Lade Video hoch...';
        progressFill.style.width = '30%';
        progressPercentage.textContent = '30%';
        
        const uploadResponse = await fetch(uploadUrl, {
            method: 'PUT',
            body: file,
            headers: {
                'Content-Type': file.type || 'video/mp4'
            }
        });
        
        if (!uploadResponse.ok) {
            throw new Error('Fehler beim Hochladen des Videos');
        }
        
        // Schritt 3: Speichere URL in Settings
        progressStatus.textContent = 'Speichere Einstellung...';
        progressFill.style.width = '80%';
        progressPercentage.textContent = '80%';
        
        const settingsResponse = await fetch('/.netlify/functions/hero-video-settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ videoUrl: publicUrl })
        });
        
        if (!settingsResponse.ok) {
            throw new Error('Fehler beim Speichern der Einstellung');
        }
        
        // Erfolg!
        progressFill.style.width = '100%';
        progressPercentage.textContent = '100%';
        progressStatus.textContent = 'Fertig!';
        
        setTimeout(() => {
            uploadProgress.style.display = 'none';
            successMessage.style.display = 'block';
            uploadBtn.disabled = false;
            fileInput.value = '';
            document.getElementById('videoPreviewContainer').style.display = 'none';
            
            // Lade aktuelles Video neu
            loadCurrentVideo();
        }, 1000);
        
    } catch (error) {
        console.error('Upload error:', error);
        alert('Fehler beim Hochladen: ' + error.message);
        uploadProgress.style.display = 'none';
        uploadBtn.disabled = false;
    }
}
</script>

