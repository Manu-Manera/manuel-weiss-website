<!-- HR-Leads Section -->
<!-- BPMN.js f√ºr Workflow-Anzeige -->
<script src="https://unpkg.com/bpmn-js@17.2.1/dist/bpmn-viewer.production.min.js"></script>

<div class="section-header">
    <h1><i class="fas fa-clipboard-check"></i> HR-Selbsttest Leads</h1>
    <p>√úbersicht aller Leads aus dem HR-Selbsttest</p>
</div>

<div class="hr-leads-container">
    <!-- Stats Cards -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 16px;">
            <div style="font-size: 2.5rem; font-weight: 800;" id="totalLeadsCount">0</div>
            <div style="opacity: 0.9;">Leads gesamt</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 1.5rem; border-radius: 16px;">
            <div style="font-size: 2.5rem; font-weight: 800;" id="consultationLeadsCount">0</div>
            <div style="opacity: 0.9;">Beratung gew√ºnscht</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 16px;">
            <div style="font-size: 2.5rem; font-weight: 800;" id="avgScoreDisplay">0.0</div>
            <div style="opacity: 0.9;">√ò Score</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #ec4899, #db2777); color: white; padding: 1.5rem; border-radius: 16px;">
            <div style="font-size: 2.5rem; font-weight: 800;" id="todayLeadsCount">0</div>
            <div style="opacity: 0.9;">Heute</div>
        </div>
    </div>

    <!-- Info Box -->
    <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
        <p style="margin: 0; color: #6366f1; font-size: 0.9rem;">
            <i class="fas fa-info-circle"></i> <strong>Hinweis:</strong> Leads werden per E-Mail an mail@manuel-weiss.ch gesendet und k√∂nnen hier verwaltet werden.
            Die Leads werden auch lokal gespeichert. Nutze "Zu S3 hochladen" um sie zentral zu sichern.
        </p>
    </div>

    <!-- Action Buttons -->
    <div class="action-bar" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
        <button onclick="refreshHRLeads()" class="btn btn-primary" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-sync-alt"></i> Aktualisieren
        </button>
        <button onclick="uploadLeadsToS3()" class="btn btn-secondary" style="background: #8b5cf6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-cloud-upload-alt"></i> Zu S3 hochladen
        </button>
        <button onclick="exportHRLeadsCSV()" class="btn btn-secondary" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-file-csv"></i> CSV Export
        </button>
        <button onclick="exportHRLeadsJSON()" class="btn btn-secondary" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-code"></i> JSON Export
        </button>
        <button onclick="importLeadsFromJSON()" class="btn btn-secondary" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-file-import"></i> JSON Import
        </button>
        <button onclick="clearAllHRLeads()" class="btn btn-danger" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-trash"></i> Alle l√∂schen
        </button>
    </div>
    <input type="file" id="jsonImportInput" accept=".json" style="display: none;" onchange="handleJSONImport(event)">

    <!-- Filter -->
    <div class="filter-bar" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center;">
        <input type="text" id="hrLeadsSearch" placeholder="Suchen nach Name oder E-Mail..." oninput="filterHRLeads()" style="flex: 1; min-width: 250px; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
        <select id="hrLeadsFilter" onchange="filterHRLeads()" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
            <option value="all">Alle Leads</option>
            <option value="consultation">Nur Beratung gew√ºnscht</option>
            <option value="high-score">High Score (‚â•3.5)</option>
            <option value="low-score">Low Score (<2.5)</option>
        </select>
    </div>

    <!-- Leads Table -->
    <div class="table-container" style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
        <table style="width: 100%; border-collapse: collapse;" id="hrLeadsTable">
            <thead>
                <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #475569;">Datum</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #475569;">Name</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #475569;">E-Mail</th>
                    <th style="padding: 1rem; text-align: center; font-weight: 600; color: #475569;">Beratung</th>
                    <th style="padding: 1rem; text-align: center; font-weight: 600; color: #475569;">Score</th>
                    <th style="padding: 1rem; text-align: center; font-weight: 600; color: #475569;">Prozesse</th>
                    <th style="padding: 1rem; text-align: center; font-weight: 600; color: #475569;">Aktionen</th>
                </tr>
            </thead>
            <tbody id="hrLeadsTableBody">
                <!-- Leads werden hier eingef√ºgt -->
            </tbody>
        </table>
        <div id="noLeadsMessage" style="display: none; text-align: center; padding: 3rem; color: #94a3b8;">
            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <p>Keine Leads vorhanden</p>
        </div>
    </div>
</div>

<!-- Lead Detail Modal -->
<div id="leadDetailModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 2rem;">
    <div style="background: white; border-radius: 16px; max-width: 900px; width: 95%; margin: 0 auto; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; position: sticky; top: 0; background: white; padding-bottom: 1rem; border-bottom: 1px solid #e2e8f0;">
            <h2 style="margin: 0; color: #1e293b;"><i class="fas fa-user-circle"></i> Lead Details</h2>
            <button onclick="closeLeadModal()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                <i class="fas fa-times"></i> Schlie√üen
            </button>
        </div>
        <div id="leadDetailContent"></div>
    </div>
</div>

<script>
// HR Leads Management - AWS API Integration
let allHRLeads = [];
const HR_LEADS_API = (window.AWS_APP_CONFIG && window.AWS_APP_CONFIG.API_BASE) || 'https://6i6ysj9c8c.execute-api.eu-central-1.amazonaws.com/v1';
const S3_LEADS_URL = 'https://manuel-weiss-website.s3.eu-central-1.amazonaws.com/data/hr-leads.json';
const ADMIN_PASSWORD = 'mw-admin-2024';
console.log('üìä HR-Leads API URL:', HR_LEADS_API);

function initHRLeadsSection() {
    console.log('HR-Leads Section initialisiert');
    refreshHRLeads();
}

async function refreshHRLeads() {
    const tableBody = document.getElementById('hrLeadsTableBody');
    if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;"><i class="fas fa-spinner fa-spin"></i> Lade Leads aus AWS...</td></tr>';
    }
    
    console.log('üîÑ Lade HR-Leads...');
    console.log('üì° API URL:', HR_LEADS_API);
    console.log('üì¶ S3 URL:', S3_LEADS_URL);
    
    // Versuche zuerst direkt aus S3 zu laden (schneller und zuverl√§ssiger)
    try {
        console.log('üì¶ Versuche S3 direkt...');
        const s3Response = await fetch(`${S3_LEADS_URL}?t=${Date.now()}`);
        console.log('üì¶ S3 Response Status:', s3Response.status);
        if (s3Response.ok) {
            const data = await s3Response.json();
            if (Array.isArray(data)) {
                allHRLeads = data;
                console.log('‚úÖ S3 Leads geladen:', allHRLeads.length);
            } else {
                throw new Error('S3 data is not an array');
            }
        } else {
            throw new Error(`S3 HTTP ${s3Response.status}`);
        }
    } catch (s3Error) {
        console.log('‚ö†Ô∏è S3 Fehler:', s3Error.message);
        
        // Fallback: API versuchen
        try {
            console.log('üì° Versuche API...');
            const apiUrl = `${HR_LEADS_API}/hr-leads/list`;
            console.log('üì° API URL:', apiUrl);
            const response = await fetch(apiUrl);
            console.log('üì° API Response Status:', response.status);
            if (response.ok) {
                const result = await response.json();
                console.log('üì° API Result:', result);
                if (result.success && result.leads) {
                    allHRLeads = result.leads;
                    console.log('‚úÖ API Leads geladen:', allHRLeads.length);
                } else {
                    throw new Error('API returned no leads');
                }
            } else {
                throw new Error(`API HTTP ${response.status}`);
            }
        } catch (apiError) {
            console.log('‚ö†Ô∏è API Fehler:', apiError.message);
            console.log('üì± Verwende localStorage als Fallback');
            allHRLeads = JSON.parse(localStorage.getItem('hrSelbsttestLeads') || '[]');
        }
    }
    
    console.log('üìä Finale Leads:', allHRLeads.length);
    
    // Stats aktualisieren
    updateHRLeadsStats();
    
    // Tabelle rendern
    renderHRLeadsTable(allHRLeads);
}

function updateHRLeadsStats() {
    const total = allHRLeads.length;
    const consultation = allHRLeads.filter(l => l.wantsConsultation).length;
    const avgScore = total > 0 ? (allHRLeads.reduce((sum, l) => sum + parseFloat(l.scores?.total || 0), 0) / total).toFixed(1) : '0.0';
    
    const today = new Date().toDateString();
    const todayLeads = allHRLeads.filter(l => new Date(l.timestamp).toDateString() === today).length;
    
    document.getElementById('totalLeadsCount').textContent = total;
    document.getElementById('consultationLeadsCount').textContent = consultation;
    document.getElementById('avgScoreDisplay').textContent = avgScore;
    document.getElementById('todayLeadsCount').textContent = todayLeads;
}

function renderHRLeadsTable(leads) {
    const tbody = document.getElementById('hrLeadsTableBody');
    const noMessage = document.getElementById('noLeadsMessage');
    
    if (leads.length === 0) {
        tbody.innerHTML = '';
        noMessage.style.display = 'block';
        return;
    }
    
    noMessage.style.display = 'none';
    
    tbody.innerHTML = leads.map((lead, index) => {
        const date = new Date(lead.timestamp).toLocaleString('de-CH');
        const score = parseFloat(lead.scores?.total || 0);
        const scoreColor = score >= 3.5 ? '#10b981' : score >= 2 ? '#f59e0b' : '#ef4444';
        
        return `
            <tr style="border-bottom: 1px solid #f1f5f9; ${index % 2 ? 'background: #fafafa;' : ''}">
                <td style="padding: 1rem; color: #64748b; font-size: 0.9rem;">${date}</td>
                <td style="padding: 1rem; font-weight: 600; color: #1e293b;">${escapeHtml(lead.name)}</td>
                <td style="padding: 1rem;">
                    <a href="mailto:${escapeHtml(lead.email)}" style="color: #6366f1; text-decoration: none;">${escapeHtml(lead.email)}</a>
                </td>
                <td style="padding: 1rem; text-align: center;">
                    ${lead.wantsConsultation ? '<span style="background: #dcfce7; color: #166534; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem;">‚úì Ja</span>' : '<span style="color: #94a3b8;">Nein</span>'}
                </td>
                <td style="padding: 1rem; text-align: center;">
                    <span style="background: ${scoreColor}; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 700;">${score.toFixed(1)}</span>
                </td>
                <td style="padding: 1rem; text-align: center; color: #64748b;">
                    ${lead.prozesseBewertet || 0}/${lead.prozesseGesamt || 32}
                </td>
                <td style="padding: 1rem; text-align: center;">
                    <button onclick="showLeadDetail(${index})" style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 4px;" title="Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="deleteLead(${index})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;" title="L√∂schen">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function filterHRLeads() {
    const search = document.getElementById('hrLeadsSearch').value.toLowerCase();
    const filter = document.getElementById('hrLeadsFilter').value;
    
    let filtered = allHRLeads.filter(lead => {
        const matchesSearch = lead.name.toLowerCase().includes(search) || lead.email.toLowerCase().includes(search);
        
        if (!matchesSearch) return false;
        
        switch(filter) {
            case 'consultation':
                return lead.wantsConsultation;
            case 'high-score':
                return parseFloat(lead.scores?.total || 0) >= 3.5;
            case 'low-score':
                return parseFloat(lead.scores?.total || 0) < 2.5;
            default:
                return true;
        }
    });
    
    renderHRLeadsTable(filtered);
}

function showLeadDetail(index) {
    const lead = allHRLeads[index];
    if (!lead) return;
    
    // PDF Download Button (nur wenn PDF vorhanden)
    const pdfButton = lead.pdfBase64 ? `
        <button onclick="downloadLeadPDF(${index})" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
            <i class="fas fa-file-pdf"></i> PDF herunterladen
        </button>
    ` : '<span style="color: #94a3b8; font-size: 0.9rem;"><i class="fas fa-info-circle"></i> Kein PDF verf√ºgbar</span>';
    
    // Antworten aufbereiten
    const answersHtml = lead.answers ? `
        <div style="background: #f0fdf4; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem 0; color: #166534;"><i class="fas fa-clipboard-list"></i> Antworten im Detail</h3>
            
            ${lead.answers.vision && Object.keys(lead.answers.vision).length > 0 ? `
                <div style="margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #15803d; font-size: 0.95rem;">Vision</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${Object.entries(lead.answers.vision).map(([key, val]) => `
                            <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem;">
                                ${key}: <strong>${val}</strong>
                            </span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${lead.answers.kultur && Object.keys(lead.answers.kultur).length > 0 ? `
                <div style="margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #15803d; font-size: 0.95rem;">Kultur</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${Object.entries(lead.answers.kultur).map(([key, val]) => `
                            <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem;">
                                ${key}: <strong>${val}</strong>
                            </span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${lead.answers.organisation && Object.keys(lead.answers.organisation).length > 0 ? `
                <div>
                    <h4 style="margin: 0 0 0.5rem 0; color: #15803d; font-size: 0.95rem;">Organisation</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${Object.entries(lead.answers.organisation).map(([key, val]) => `
                            <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem;">
                                ${key}: <strong>${val}</strong>
                            </span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    ` : '';
    
    // Prozess-Details aufbereiten
    const prozessHtml = lead.prozessDetails && Object.keys(lead.prozessDetails).length > 0 ? `
        <div style="background: #faf5ff; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem 0; color: #7c3aed;"><i class="fas fa-cogs"></i> Bewertete Prozesse (${Object.keys(lead.prozessDetails).length})</h3>
            <div style="max-height: 400px; overflow-y: auto;">
                ${Object.entries(lead.prozessDetails).map(([processId, proc]) => `
                    <div style="background: white; border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid ${proc.hasBpmn ? '#10b981' : '#e2e8f0'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <div style="font-weight: 600; color: #1e293b;">${escapeHtml(proc.name || processId)}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">${escapeHtml(proc.category || '')}</div>
                            </div>
                            ${proc.hasBpmn ? '<span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;"><i class="fas fa-sitemap"></i> Workflow</span>' : ''}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; font-size: 0.8rem; margin-bottom: 0.5rem;">
                            <div style="text-align: center;">
                                <div style="color: #94a3b8;">Digi-Ist</div>
                                <div style="font-weight: 600; color: #6366f1;">${proc.digiIst || '-'}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #94a3b8;">Digi-Soll</div>
                                <div style="font-weight: 600; color: #8b5cf6;">${proc.digiSoll || '-'}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #94a3b8;">Qual-Ist</div>
                                <div style="font-weight: 600; color: #f59e0b;">${proc.qualIst || '-'}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #94a3b8;">Qual-Soll</div>
                                <div style="font-weight: 600; color: #f97316;">${proc.qualSoll || '-'}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #94a3b8;">Wichtig</div>
                                <div style="font-weight: 600; color: #ec4899;">${proc.wichtigkeit || '-'}</div>
                            </div>
                        </div>
                        ${proc.description ? `<div style="background: #f8fafc; padding: 0.5rem; border-radius: 6px; font-size: 0.85rem; color: #475569; margin-top: 0.5rem;"><strong>Beschreibung:</strong> ${escapeHtml(proc.description)}</div>` : ''}
                        ${proc.tools ? `<div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;"><strong>Tools:</strong> ${escapeHtml(proc.tools)}</div>` : ''}
                        ${proc.notes ? `<div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;"><strong>Notizen:</strong> ${escapeHtml(proc.notes)}</div>` : ''}
                        ${proc.hasBpmn ? `<button onclick="showBpmnModal(${JSON.stringify(proc.bpmnXml).replace(/"/g, '&quot;')})" style="background: #10b981; color: white; border: none; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 0.5rem;"><i class="fas fa-project-diagram"></i> BPMN anzeigen</button>` : ''}
                    </div>
                `).join('')}
            </div>
        </div>
    ` : '';
    
    const content = document.getElementById('leadDetailContent');
    content.innerHTML = `
        <div style="margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <div style="color: #64748b; font-size: 0.85rem;">Name</div>
                    <div style="font-weight: 600; font-size: 1.1rem;">${escapeHtml(lead.name)}</div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 0.85rem;">E-Mail</div>
                    <div><a href="mailto:${escapeHtml(lead.email)}" style="color: #6366f1;">${escapeHtml(lead.email)}</a></div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 0.85rem;">Beratung gew√ºnscht</div>
                    <div style="font-weight: 600; color: ${lead.wantsConsultation ? '#10b981' : '#94a3b8'};">${lead.wantsConsultation ? 'Ja' : 'Nein'}</div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 0.85rem;">Datum</div>
                    <div>${new Date(lead.timestamp).toLocaleString('de-CH')}</div>
                </div>
            </div>
        </div>
        
        <!-- PDF Download -->
        <div style="margin-bottom: 1.5rem; display: flex; justify-content: center;">
            ${pdfButton}
        </div>
        
        <div style="background: #f8fafc; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem 0; color: #1e293b;"><i class="fas fa-chart-bar"></i> Scores</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                ${['vision', 'kultur', 'organisation', 'prozesse'].map(dim => {
                    const score = parseFloat(lead.scores?.[dim] || 0);
                    const color = score >= 3.5 ? '#10b981' : score >= 2 ? '#f59e0b' : '#ef4444';
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="text-transform: capitalize;">${dim}</span>
                            <span style="background: ${color}; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 600;">${score}</span>
                        </div>
                    `;
                }).join('')}
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600;">Gesamt</span>
                <span style="font-size: 1.5rem; font-weight: 800; color: #6366f1;">${lead.scores?.total || '0.00'}</span>
            </div>
        </div>
        
        ${answersHtml}
        
        ${prozessHtml}
        
        <div style="background: #fef3c7; border-radius: 12px; padding: 1rem;">
            <div style="color: #92400e; font-size: 0.85rem;">Prozesse bewertet</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #78350f;">${lead.prozesseBewertet || 0} von ${lead.prozesseGesamt || 32}</div>
        </div>
    `;
    
    document.getElementById('leadDetailModal').style.display = 'flex';
}

function closeLeadModal() {
    document.getElementById('leadDetailModal').style.display = 'none';
}

// PDF aus Lead herunterladen
function downloadLeadPDF(index) {
    const lead = allHRLeads[index];
    if (!lead || !lead.pdfBase64) {
        alert('Kein PDF f√ºr diesen Lead verf√ºgbar.');
        return;
    }
    
    try {
        // Base64 zu Blob konvertieren
        const byteCharacters = atob(lead.pdfBase64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });
        
        // Download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `HR-Report-${lead.name.replace(/\s+/g, '-')}-${new Date(lead.timestamp).toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('‚úÖ PDF heruntergeladen f√ºr:', lead.name);
    } catch (error) {
        console.error('PDF Download Fehler:', error);
        alert('Fehler beim PDF-Download: ' + error.message);
    }
}

// BPMN Modal anzeigen
function showBpmnModal(bpmnXml) {
    // Modal erstellen falls nicht vorhanden
    let modal = document.getElementById('bpmnViewerModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'bpmnViewerModal';
        modal.innerHTML = `
            <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 20000; display: flex; justify-content: center; align-items: center; padding: 2rem;">
                <div style="background: white; border-radius: 16px; width: 90%; max-width: 1200px; height: 80vh; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h3 style="margin: 0; color: #1e293b;"><i class="fas fa-project-diagram"></i> BPMN Workflow</h3>
                        <button onclick="closeBpmnModal()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-times"></i> Schlie√üen
                        </button>
                    </div>
                    <div id="bpmnViewerContainer" style="flex: 1; overflow: hidden;"></div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    modal.style.display = 'block';
    
    // BPMN Viewer laden (falls bpmn-js verf√ºgbar)
    const container = document.getElementById('bpmnViewerContainer');
    
    // Pr√ºfen ob bpmn-js geladen ist
    if (typeof BpmnJS !== 'undefined') {
        const viewer = new BpmnJS({ container: container });
        viewer.importXML(bpmnXml).then(() => {
            const canvas = viewer.get('canvas');
            canvas.zoom('fit-viewport');
        }).catch(err => {
            console.error('BPMN Render Fehler:', err);
            container.innerHTML = `<div style="padding: 2rem; text-align: center; color: #ef4444;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <p>Fehler beim Rendern des BPMN-Diagramms</p>
                <pre style="text-align: left; background: #f8fafc; padding: 1rem; border-radius: 8px; overflow: auto; max-height: 300px; font-size: 0.8rem;">${escapeHtml(bpmnXml)}</pre>
            </div>`;
        });
    } else {
        // bpmn-js nicht verf√ºgbar - XML anzeigen
        container.innerHTML = `<div style="padding: 2rem;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; color: #92400e;">
                <i class="fas fa-info-circle"></i> BPMN-Viewer nicht geladen. XML-Ansicht:
            </div>
            <pre style="background: #f8fafc; padding: 1rem; border-radius: 8px; overflow: auto; max-height: 60vh; font-size: 0.85rem; white-space: pre-wrap;">${escapeHtml(bpmnXml)}</pre>
        </div>`;
    }
}

function closeBpmnModal() {
    const modal = document.getElementById('bpmnViewerModal');
    if (modal) {
        modal.style.display = 'none';
        // Container leeren
        const container = document.getElementById('bpmnViewerContainer');
        if (container) container.innerHTML = '';
    }
}

async function deleteLead(index) {
    if (!confirm('Lead wirklich l√∂schen?')) return;
    
    const lead = allHRLeads[index];
    if (!lead) return;
    
    try {
        if (lead.id) {
            // Aus AWS l√∂schen
            const response = await fetch(`${HR_LEADS_API}/delete?id=${lead.id}&adminPw=${ADMIN_PASSWORD}`, {
                method: 'DELETE',
                headers: { 'X-Admin-Password': ADMIN_PASSWORD }
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.error);
        }
        
        allHRLeads.splice(index, 1);
        console.log('‚úÖ Lead gel√∂scht');
        refreshHRLeads();
    } catch (error) {
        console.error('Fehler beim L√∂schen:', error);
        // Trotzdem lokal entfernen
        allHRLeads.splice(index, 1);
        refreshHRLeads();
    }
}

async function clearAllHRLeads() {
    if (!confirm('ALLE Leads wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!')) return;
    
    try {
        // In AWS l√∂schen
        const response = await fetch(`${HR_LEADS_API}/clear?adminPw=${ADMIN_PASSWORD}`, {
            method: 'DELETE',
            headers: { 'X-Admin-Password': ADMIN_PASSWORD }
        });
        const result = await response.json();
        console.log('AWS Clear:', result);
    } catch (error) {
        console.error('AWS Clear Fehler:', error);
    }
    
    // Auch localStorage l√∂schen
    localStorage.removeItem('hrSelbsttestLeads');
    allHRLeads = [];
    refreshHRLeads();
}

function exportHRLeadsCSV() {
    if (allHRLeads.length === 0) {
        alert('Keine Leads zum Exportieren');
        return;
    }
    
    const headers = ['Datum', 'Name', 'E-Mail', 'Beratung', 'Score Gesamt', 'Vision', 'Kultur', 'Organisation', 'Prozesse', 'Prozesse bewertet'];
    const rows = allHRLeads.map(l => [
        new Date(l.timestamp).toLocaleString('de-CH'),
        l.name,
        l.email,
        l.wantsConsultation ? 'Ja' : 'Nein',
        l.scores?.total || '0',
        l.scores?.vision || '0',
        l.scores?.kultur || '0',
        l.scores?.organisation || '0',
        l.scores?.prozesse || '0',
        `${l.prozesseBewertet || 0}/${l.prozesseGesamt || 32}`
    ]);
    
    const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
    downloadFile(csv, 'hr-leads-export.csv', 'text/csv');
}

function exportHRLeadsJSON() {
    if (allHRLeads.length === 0) {
        alert('Keine Leads zum Exportieren');
        return;
    }
    
    downloadFile(JSON.stringify(allHRLeads, null, 2), 'hr-leads-export.json', 'application/json');
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Upload Leads to S3 via AWS SDK (if available)
async function uploadLeadsToS3() {
    if (allHRLeads.length === 0) {
        alert('Keine Leads zum Hochladen');
        return;
    }
    
    try {
        // Versuche √ºber AWS SDK hochzuladen
        if (window.AWS && window.AWS.S3) {
            const s3 = new AWS.S3({
                region: 'eu-central-1'
            });
            
            await s3.putObject({
                Bucket: 'manuel-weiss-website',
                Key: 'data/hr-leads.json',
                Body: JSON.stringify(allHRLeads, null, 2),
                ContentType: 'application/json'
            }).promise();
            
            alert('‚úÖ Leads erfolgreich zu S3 hochgeladen!');
        } else {
            // Fallback: Zeige Anleitung f√ºr manuellen Upload
            const json = JSON.stringify(allHRLeads, null, 2);
            downloadFile(json, 'hr-leads.json', 'application/json');
            alert('AWS SDK nicht verf√ºgbar.\n\nDie JSON-Datei wurde heruntergeladen.\nBitte manuell zu S3 hochladen:\n\n1. AWS Console √∂ffnen\n2. S3 > manuel-weiss-website > data/\n3. hr-leads.json hochladen');
        }
    } catch (error) {
        console.error('S3 Upload Fehler:', error);
        // Fallback: Download
        const json = JSON.stringify(allHRLeads, null, 2);
        downloadFile(json, 'hr-leads.json', 'application/json');
        alert('Upload fehlgeschlagen: ' + error.message + '\n\nDie JSON-Datei wurde heruntergeladen. Bitte manuell zu S3 hochladen.');
    }
}

// Import Leads from JSON file
function importLeadsFromJSON() {
    document.getElementById('jsonImportInput').click();
}

function handleJSONImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedLeads = JSON.parse(e.target.result);
            if (!Array.isArray(importedLeads)) {
                throw new Error('Datei muss ein Array sein');
            }
            
            // Merge mit bestehenden Leads (nach Email deduplizieren)
            const existingEmails = new Set(allHRLeads.map(l => l.email));
            const newLeads = importedLeads.filter(l => !existingEmails.has(l.email));
            
            allHRLeads = [...newLeads, ...allHRLeads];
            localStorage.setItem('hrSelbsttestLeads', JSON.stringify(allHRLeads));
            
            alert(`‚úÖ Import erfolgreich!\n${newLeads.length} neue Leads hinzugef√ºgt.\n${importedLeads.length - newLeads.length} Duplikate √ºbersprungen.`);
            refreshHRLeads();
        } catch (error) {
            alert('Import fehlgeschlagen: ' + error.message);
        }
    };
    reader.readAsText(file);
    
    // Reset input
    event.target.value = '';
}

// Sofortige Initialisierung
(function() {
    console.log('üöÄ HR-Leads Script geladen');
    
    // Pr√ºfe ob DOM-Elemente vorhanden sind
    function tryInit() {
        const tableBody = document.getElementById('hrLeadsTableBody');
        console.log('üîç Suche hrLeadsTableBody:', tableBody ? 'GEFUNDEN' : 'NICHT GEFUNDEN');
        
        if (tableBody) {
            console.log('‚úÖ HR-Leads DOM ready, starte Initialisierung...');
            initHRLeadsSection();
        } else {
            console.log('‚è≥ Warte auf HR-Leads DOM...');
            setTimeout(tryInit, 200);
        }
    }
    
    // Starte sofort
    tryInit();
})();
</script>
