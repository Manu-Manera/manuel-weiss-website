<!-- HR-Leads Section -->
<div class="section-header">
    <h1><i class="fas fa-clipboard-check"></i> HR-Selbsttest Leads</h1>
    <p>Übersicht aller Leads aus dem HR-Selbsttest</p>
</div>

<div class="hr-leads-container">
    <!-- Stats Cards -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 16px;">
            <div style="font-size: 2.5rem; font-weight: 800;" id="totalLeadsCount">0</div>
            <div style="opacity: 0.9;">Leads gesamt</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 1.5rem; border-radius: 16px;">
            <div style="font-size: 2.5rem; font-weight: 800;" id="consultationLeadsCount">0</div>
            <div style="opacity: 0.9;">Beratung gewünscht</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 16px;">
            <div style="font-size: 2.5rem; font-weight: 800;" id="avgScoreDisplay">0.0</div>
            <div style="opacity: 0.9;">Ø Score</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #ec4899, #db2777); color: white; padding: 1.5rem; border-radius: 16px;">
            <div style="font-size: 2.5rem; font-weight: 800;" id="todayLeadsCount">0</div>
            <div style="opacity: 0.9;">Heute</div>
        </div>
    </div>

    <!-- Info Box -->
    <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
        <p style="margin: 0; color: #6366f1; font-size: 0.9rem;">
            <i class="fas fa-info-circle"></i> <strong>Hinweis:</strong> Leads werden per E-Mail an mail@manuel-weiss.ch gesendet und können hier verwaltet werden.
            Die Leads werden auch lokal gespeichert. Nutze "Zu S3 hochladen" um sie zentral zu sichern.
        </p>
    </div>

    <!-- Action Buttons -->
    <div class="action-bar" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
        <button onclick="refreshHRLeads()" class="btn btn-primary" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-sync-alt"></i> Aktualisieren
        </button>
        <button onclick="uploadLeadsToS3()" class="btn btn-secondary" style="background: #8b5cf6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-cloud-upload-alt"></i> Zu S3 hochladen
        </button>
        <button onclick="exportHRLeadsCSV()" class="btn btn-secondary" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-file-csv"></i> CSV Export
        </button>
        <button onclick="exportHRLeadsJSON()" class="btn btn-secondary" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-code"></i> JSON Export
        </button>
        <button onclick="importLeadsFromJSON()" class="btn btn-secondary" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-file-import"></i> JSON Import
        </button>
        <button onclick="clearAllHRLeads()" class="btn btn-danger" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-trash"></i> Alle löschen
        </button>
    </div>
    <input type="file" id="jsonImportInput" accept=".json" style="display: none;" onchange="handleJSONImport(event)">

    <!-- Filter -->
    <div class="filter-bar" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center;">
        <input type="text" id="hrLeadsSearch" placeholder="Suchen nach Name oder E-Mail..." oninput="filterHRLeads()" style="flex: 1; min-width: 250px; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
        <select id="hrLeadsFilter" onchange="filterHRLeads()" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
            <option value="all">Alle Leads</option>
            <option value="consultation">Nur Beratung gewünscht</option>
            <option value="high-score">High Score (≥3.5)</option>
            <option value="low-score">Low Score (<2.5)</option>
        </select>
    </div>

    <!-- Leads Table -->
    <div class="table-container" style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
        <table style="width: 100%; border-collapse: collapse;" id="hrLeadsTable">
            <thead>
                <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #475569;">Datum</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #475569;">Name</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #475569;">E-Mail</th>
                    <th style="padding: 1rem; text-align: center; font-weight: 600; color: #475569;">Beratung</th>
                    <th style="padding: 1rem; text-align: center; font-weight: 600; color: #475569;">Score</th>
                    <th style="padding: 1rem; text-align: center; font-weight: 600; color: #475569;">Prozesse</th>
                    <th style="padding: 1rem; text-align: center; font-weight: 600; color: #475569;">Aktionen</th>
                </tr>
            </thead>
            <tbody id="hrLeadsTableBody">
                <!-- Leads werden hier eingefügt -->
            </tbody>
        </table>
        <div id="noLeadsMessage" style="display: none; text-align: center; padding: 3rem; color: #94a3b8;">
            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <p>Keine Leads vorhanden</p>
        </div>
    </div>
</div>

<!-- Lead Detail Modal -->
<div id="leadDetailModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; color: #1e293b;">Lead Details</h2>
            <button onclick="closeLeadModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8;">&times;</button>
        </div>
        <div id="leadDetailContent"></div>
    </div>
</div>

<script>
// HR Leads Management - AWS S3 Direct Integration
let allHRLeads = [];
const S3_LEADS_URL = 'https://manuel-weiss-website.s3.eu-central-1.amazonaws.com/data/hr-leads.json';
const ADMIN_PASSWORD = 'mw-admin-2024';

function initHRLeadsSection() {
    console.log('HR-Leads Section initialisiert');
    refreshHRLeads();
}

async function refreshHRLeads() {
    const tableBody = document.getElementById('hrLeadsTableBody');
    if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;"><i class="fas fa-spinner fa-spin"></i> Lade Leads aus AWS S3...</td></tr>';
    }
    
    try {
        // Leads direkt aus S3 laden (mit Cache-Buster)
        const response = await fetch(`${S3_LEADS_URL}?t=${Date.now()}`);
        if (response.ok) {
            allHRLeads = await response.json();
            console.log('✅ S3 Leads geladen:', allHRLeads.length);
        } else {
            throw new Error('S3 nicht erreichbar');
        }
    } catch (error) {
        console.log('⚠️ S3 Fehler, verwende localStorage:', error);
        allHRLeads = JSON.parse(localStorage.getItem('hrSelbsttestLeads') || '[]');
    }
    
    // Stats aktualisieren
    updateHRLeadsStats();
    
    // Tabelle rendern
    renderHRLeadsTable(allHRLeads);
}

function updateHRLeadsStats() {
    const total = allHRLeads.length;
    const consultation = allHRLeads.filter(l => l.wantsConsultation).length;
    const avgScore = total > 0 ? (allHRLeads.reduce((sum, l) => sum + parseFloat(l.scores?.total || 0), 0) / total).toFixed(1) : '0.0';
    
    const today = new Date().toDateString();
    const todayLeads = allHRLeads.filter(l => new Date(l.timestamp).toDateString() === today).length;
    
    document.getElementById('totalLeadsCount').textContent = total;
    document.getElementById('consultationLeadsCount').textContent = consultation;
    document.getElementById('avgScoreDisplay').textContent = avgScore;
    document.getElementById('todayLeadsCount').textContent = todayLeads;
}

function renderHRLeadsTable(leads) {
    const tbody = document.getElementById('hrLeadsTableBody');
    const noMessage = document.getElementById('noLeadsMessage');
    
    if (leads.length === 0) {
        tbody.innerHTML = '';
        noMessage.style.display = 'block';
        return;
    }
    
    noMessage.style.display = 'none';
    
    tbody.innerHTML = leads.map((lead, index) => {
        const date = new Date(lead.timestamp).toLocaleString('de-CH');
        const score = parseFloat(lead.scores?.total || 0);
        const scoreColor = score >= 3.5 ? '#10b981' : score >= 2 ? '#f59e0b' : '#ef4444';
        
        return `
            <tr style="border-bottom: 1px solid #f1f5f9; ${index % 2 ? 'background: #fafafa;' : ''}">
                <td style="padding: 1rem; color: #64748b; font-size: 0.9rem;">${date}</td>
                <td style="padding: 1rem; font-weight: 600; color: #1e293b;">${escapeHtml(lead.name)}</td>
                <td style="padding: 1rem;">
                    <a href="mailto:${escapeHtml(lead.email)}" style="color: #6366f1; text-decoration: none;">${escapeHtml(lead.email)}</a>
                </td>
                <td style="padding: 1rem; text-align: center;">
                    ${lead.wantsConsultation ? '<span style="background: #dcfce7; color: #166534; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem;">✓ Ja</span>' : '<span style="color: #94a3b8;">Nein</span>'}
                </td>
                <td style="padding: 1rem; text-align: center;">
                    <span style="background: ${scoreColor}; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 700;">${score.toFixed(1)}</span>
                </td>
                <td style="padding: 1rem; text-align: center; color: #64748b;">
                    ${lead.prozesseBewertet || 0}/${lead.prozesseGesamt || 32}
                </td>
                <td style="padding: 1rem; text-align: center;">
                    <button onclick="showLeadDetail(${index})" style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 4px;" title="Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="deleteLead(${index})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;" title="Löschen">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function filterHRLeads() {
    const search = document.getElementById('hrLeadsSearch').value.toLowerCase();
    const filter = document.getElementById('hrLeadsFilter').value;
    
    let filtered = allHRLeads.filter(lead => {
        const matchesSearch = lead.name.toLowerCase().includes(search) || lead.email.toLowerCase().includes(search);
        
        if (!matchesSearch) return false;
        
        switch(filter) {
            case 'consultation':
                return lead.wantsConsultation;
            case 'high-score':
                return parseFloat(lead.scores?.total || 0) >= 3.5;
            case 'low-score':
                return parseFloat(lead.scores?.total || 0) < 2.5;
            default:
                return true;
        }
    });
    
    renderHRLeadsTable(filtered);
}

function showLeadDetail(index) {
    const lead = allHRLeads[index];
    if (!lead) return;
    
    const content = document.getElementById('leadDetailContent');
    content.innerHTML = `
        <div style="margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <div style="color: #64748b; font-size: 0.85rem;">Name</div>
                    <div style="font-weight: 600; font-size: 1.1rem;">${escapeHtml(lead.name)}</div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 0.85rem;">E-Mail</div>
                    <div><a href="mailto:${escapeHtml(lead.email)}" style="color: #6366f1;">${escapeHtml(lead.email)}</a></div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 0.85rem;">Beratung gewünscht</div>
                    <div style="font-weight: 600; color: ${lead.wantsConsultation ? '#10b981' : '#94a3b8'};">${lead.wantsConsultation ? 'Ja' : 'Nein'}</div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 0.85rem;">Datum</div>
                    <div>${new Date(lead.timestamp).toLocaleString('de-CH')}</div>
                </div>
            </div>
        </div>
        
        <div style="background: #f8fafc; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem 0; color: #1e293b;">Scores</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                ${['vision', 'kultur', 'organisation', 'prozesse'].map(dim => {
                    const score = parseFloat(lead.scores?.[dim] || 0);
                    const color = score >= 3.5 ? '#10b981' : score >= 2 ? '#f59e0b' : '#ef4444';
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="text-transform: capitalize;">${dim}</span>
                            <span style="background: ${color}; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 600;">${score}</span>
                        </div>
                    `;
                }).join('')}
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600;">Gesamt</span>
                <span style="font-size: 1.5rem; font-weight: 800; color: #6366f1;">${lead.scores?.total || '0.00'}</span>
            </div>
        </div>
        
        <div style="background: #fef3c7; border-radius: 12px; padding: 1rem;">
            <div style="color: #92400e; font-size: 0.85rem;">Prozesse bewertet</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #78350f;">${lead.prozesseBewertet || 0} von ${lead.prozesseGesamt || 32}</div>
        </div>
    `;
    
    document.getElementById('leadDetailModal').style.display = 'flex';
}

function closeLeadModal() {
    document.getElementById('leadDetailModal').style.display = 'none';
}

async function deleteLead(index) {
    if (!confirm('Lead wirklich löschen?')) return;
    
    const lead = allHRLeads[index];
    if (!lead) return;
    
    try {
        if (lead.id) {
            // Aus AWS löschen
            const response = await fetch(`${HR_LEADS_API}/delete?id=${lead.id}&adminPw=${ADMIN_PASSWORD}`, {
                method: 'DELETE',
                headers: { 'X-Admin-Password': ADMIN_PASSWORD }
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.error);
        }
        
        allHRLeads.splice(index, 1);
        console.log('✅ Lead gelöscht');
        refreshHRLeads();
    } catch (error) {
        console.error('Fehler beim Löschen:', error);
        // Trotzdem lokal entfernen
        allHRLeads.splice(index, 1);
        refreshHRLeads();
    }
}

async function clearAllHRLeads() {
    if (!confirm('ALLE Leads wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden!')) return;
    
    try {
        // In AWS löschen
        const response = await fetch(`${HR_LEADS_API}/clear?adminPw=${ADMIN_PASSWORD}`, {
            method: 'DELETE',
            headers: { 'X-Admin-Password': ADMIN_PASSWORD }
        });
        const result = await response.json();
        console.log('AWS Clear:', result);
    } catch (error) {
        console.error('AWS Clear Fehler:', error);
    }
    
    // Auch localStorage löschen
    localStorage.removeItem('hrSelbsttestLeads');
    allHRLeads = [];
    refreshHRLeads();
}

function exportHRLeadsCSV() {
    if (allHRLeads.length === 0) {
        alert('Keine Leads zum Exportieren');
        return;
    }
    
    const headers = ['Datum', 'Name', 'E-Mail', 'Beratung', 'Score Gesamt', 'Vision', 'Kultur', 'Organisation', 'Prozesse', 'Prozesse bewertet'];
    const rows = allHRLeads.map(l => [
        new Date(l.timestamp).toLocaleString('de-CH'),
        l.name,
        l.email,
        l.wantsConsultation ? 'Ja' : 'Nein',
        l.scores?.total || '0',
        l.scores?.vision || '0',
        l.scores?.kultur || '0',
        l.scores?.organisation || '0',
        l.scores?.prozesse || '0',
        `${l.prozesseBewertet || 0}/${l.prozesseGesamt || 32}`
    ]);
    
    const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
    downloadFile(csv, 'hr-leads-export.csv', 'text/csv');
}

function exportHRLeadsJSON() {
    if (allHRLeads.length === 0) {
        alert('Keine Leads zum Exportieren');
        return;
    }
    
    downloadFile(JSON.stringify(allHRLeads, null, 2), 'hr-leads-export.json', 'application/json');
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Upload Leads to S3 via AWS SDK (if available)
async function uploadLeadsToS3() {
    if (allHRLeads.length === 0) {
        alert('Keine Leads zum Hochladen');
        return;
    }
    
    try {
        // Versuche über AWS SDK hochzuladen
        if (window.AWS && window.AWS.S3) {
            const s3 = new AWS.S3({
                region: 'eu-central-1'
            });
            
            await s3.putObject({
                Bucket: 'manuel-weiss-website',
                Key: 'data/hr-leads.json',
                Body: JSON.stringify(allHRLeads, null, 2),
                ContentType: 'application/json'
            }).promise();
            
            alert('✅ Leads erfolgreich zu S3 hochgeladen!');
        } else {
            // Fallback: Zeige Anleitung für manuellen Upload
            const json = JSON.stringify(allHRLeads, null, 2);
            downloadFile(json, 'hr-leads.json', 'application/json');
            alert('AWS SDK nicht verfügbar.\n\nDie JSON-Datei wurde heruntergeladen.\nBitte manuell zu S3 hochladen:\n\n1. AWS Console öffnen\n2. S3 > manuel-weiss-website > data/\n3. hr-leads.json hochladen');
        }
    } catch (error) {
        console.error('S3 Upload Fehler:', error);
        // Fallback: Download
        const json = JSON.stringify(allHRLeads, null, 2);
        downloadFile(json, 'hr-leads.json', 'application/json');
        alert('Upload fehlgeschlagen: ' + error.message + '\n\nDie JSON-Datei wurde heruntergeladen. Bitte manuell zu S3 hochladen.');
    }
}

// Import Leads from JSON file
function importLeadsFromJSON() {
    document.getElementById('jsonImportInput').click();
}

function handleJSONImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedLeads = JSON.parse(e.target.result);
            if (!Array.isArray(importedLeads)) {
                throw new Error('Datei muss ein Array sein');
            }
            
            // Merge mit bestehenden Leads (nach Email deduplizieren)
            const existingEmails = new Set(allHRLeads.map(l => l.email));
            const newLeads = importedLeads.filter(l => !existingEmails.has(l.email));
            
            allHRLeads = [...newLeads, ...allHRLeads];
            localStorage.setItem('hrSelbsttestLeads', JSON.stringify(allHRLeads));
            
            alert(`✅ Import erfolgreich!\n${newLeads.length} neue Leads hinzugefügt.\n${importedLeads.length - newLeads.length} Duplikate übersprungen.`);
            refreshHRLeads();
        } catch (error) {
            alert('Import fehlgeschlagen: ' + error.message);
        }
    };
    reader.readAsText(file);
    
    // Reset input
    event.target.value = '';
}

// Auto-Init
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHRLeadsSection);
} else {
    initHRLeadsSection();
}
</script>
