<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2FA-Einstellungen - Manuel Weiss</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        .mfa-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .mfa-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .mfa-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            background: #f3f4f6;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .mfa-status.enabled {
            background: #d1fae5;
            color: #065f46;
        }
        .mfa-status.disabled {
            background: #fee2e2;
            color: #991b1b;
        }
        .qr-code-container {
            text-align: center;
            padding: 2rem;
            background: #f9fafb;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        #qrCode {
            max-width: 256px;
            margin: 0 auto;
            display: block;
        }
        .secret-display {
            background: #1f2937;
            color: #10b981;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            text-align: center;
            letter-spacing: 0.2rem;
            margin: 1rem 0;
            word-break: break-all;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1rem;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="mfa-container">
        <h1><i class="fas fa-shield-alt"></i> Zwei-Faktor-Authentifizierung (2FA)</h1>
        
        <div id="mfaStatus" class="mfa-status">
            <div>
                <i class="fas fa-spinner fa-spin"></i>
                <span>Lade Status...</span>
            </div>
        </div>

        <!-- TOTP Setup Card -->
        <div class="mfa-card" id="totpSetupCard" style="display: none;">
            <h2><i class="fas fa-mobile-alt"></i> Authenticator App (TOTP)</h2>
            <p>Verwenden Sie eine Authenticator-App (z.B. Google Authenticator, Microsoft Authenticator) für zusätzliche Sicherheit.</p>
            
            <div id="totpSetupStep1">
                <button class="btn btn-primary" onclick="mfaManager.startTOTPSetup()">
                    <i class="fas fa-qrcode"></i> 2FA mit Authenticator App aktivieren
                </button>
            </div>

            <div id="totpSetupStep2" style="display: none;">
                <div class="qr-code-container">
                    <h3>Scannen Sie diesen QR-Code mit Ihrer Authenticator-App:</h3>
                    <canvas id="qrCode"></canvas>
                    <p style="margin-top: 1rem; color: #6b7280;">
                        Oder geben Sie diesen Code manuell ein:
                    </p>
                    <div class="secret-display" id="secretDisplay"></div>
                </div>
                
                <div class="form-group">
                    <label for="totpVerificationCode">Geben Sie den 6-stelligen Code aus Ihrer App ein:</label>
                    <input 
                        type="text" 
                        id="totpVerificationCode" 
                        placeholder="000000" 
                        maxlength="6"
                        pattern="[0-9]{6}"
                        inputmode="numeric"
                        style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem; font-family: 'Courier New', monospace;"
                    >
                </div>
                
                <button class="btn btn-primary" onclick="mfaManager.verifyAndEnableTOTP()">
                    <i class="fas fa-check"></i> Verifizieren und aktivieren
                </button>
                <button class="btn btn-secondary" onclick="mfaManager.cancelTOTPSetup()" style="margin-left: 1rem;">
                    Abbrechen
                </button>
            </div>
        </div>

        <!-- MFA Disable Card -->
        <div class="mfa-card" id="mfaDisableCard" style="display: none;">
            <h2><i class="fas fa-ban"></i> 2FA deaktivieren</h2>
            <p>Wenn Sie 2FA deaktivieren, wird Ihr Konto weniger sicher. Wir empfehlen, 2FA aktiviert zu lassen.</p>
            <button class="btn btn-danger" onclick="mfaManager.disableMFA()">
                <i class="fas fa-times"></i> 2FA deaktivieren
            </button>
        </div>

        <div id="messageContainer"></div>
    </div>

    <!-- Scripts -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1490.0.min.js"></script>
    <script src="js/real-user-auth-system.js"></script>
    <script src="js/mfa-setup.js"></script>
    <script>
        // MFA Manager
        class MFAManager {
            constructor() {
                this.mfaSetup = null;
                this.currentSecret = null;
                this.currentQRCodeUrl = null;
            }

            async init() {
                // Warte auf Auth-System
                if (!window.realUserAuth || !window.realUserAuth.isInitialized) {
                    setTimeout(() => this.init(), 500);
                    return;
                }

                // Prüfe ob Benutzer angemeldet ist
                if (!window.realUserAuth.isAuthenticated) {
                    this.showMessage('Bitte melden Sie sich an, um 2FA zu verwalten.', 'error');
                    return;
                }

                // Initialisiere MFA Setup
                this.mfaSetup = new MFASetup(window.realUserAuth);

                // Lade MFA-Status
                await this.loadMFAStatus();
            }

            async loadMFAStatus() {
                try {
                    const status = await this.mfaSetup.checkMFAStatus();
                    this.displayMFAStatus(status);
                } catch (error) {
                    console.error('Fehler beim Laden des MFA-Status:', error);
                    this.showMessage('Fehler beim Laden des 2FA-Status: ' + error.message, 'error');
                }
            }

            displayMFAStatus(status) {
                const statusEl = document.getElementById('mfaStatus');
                const totpCard = document.getElementById('totpSetupCard');
                const disableCard = document.getElementById('mfaDisableCard');

                if (status.enabled) {
                    statusEl.className = 'mfa-status enabled';
                    statusEl.innerHTML = `
                        <div>
                            <i class="fas fa-shield-alt"></i>
                            <strong>2FA ist aktiviert</strong>
                            <span style="margin-left: 1rem; font-size: 0.9rem;">Typ: ${status.type}</span>
                        </div>
                    `;
                    totpCard.style.display = 'none';
                    disableCard.style.display = 'block';
                } else {
                    statusEl.className = 'mfa-status disabled';
                    statusEl.innerHTML = `
                        <div>
                            <i class="fas fa-shield-alt"></i>
                            <strong>2FA ist nicht aktiviert</strong>
                        </div>
                    `;
                    totpCard.style.display = 'block';
                    disableCard.style.display = 'none';
                }
            }

            async startTOTPSetup() {
                try {
                    this.showMessage('Starte 2FA-Setup...', 'info');
                    
                    const result = await this.mfaSetup.startTOTPSetup();
                    
                    this.currentSecret = result.secretCode;
                    this.currentQRCodeUrl = result.qrCodeUrl;

                    // Zeige QR-Code
                    QRCode.toCanvas(document.getElementById('qrCode'), result.qrCodeUrl, {
                        width: 256,
                        margin: 2
                    });

                    // Zeige Secret
                    document.getElementById('secretDisplay').textContent = result.manualEntryKey;

                    // Zeige Step 2
                    document.getElementById('totpSetupStep1').style.display = 'none';
                    document.getElementById('totpSetupStep2').style.display = 'block';

                    // Focus auf Code-Eingabe
                    const codeInput = document.getElementById('totpVerificationCode');
                    codeInput.focus();
                    codeInput.select();

                    // Auto-Submit bei 6 Ziffern
                    codeInput.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/[^0-9]/g, '');
                        if (e.target.value.length === 6) {
                            setTimeout(() => this.verifyAndEnableTOTP(), 300);
                        }
                    });

                    this.showMessage('Scannen Sie den QR-Code mit Ihrer Authenticator-App.', 'success');
                } catch (error) {
                    this.showMessage('Fehler beim Starten des 2FA-Setups: ' + error.message, 'error');
                }
            }

            async verifyAndEnableTOTP() {
                const code = document.getElementById('totpVerificationCode').value;
                
                if (!code || code.length !== 6) {
                    this.showMessage('Bitte geben Sie einen 6-stelligen Code ein.', 'error');
                    return;
                }

                try {
                    this.showMessage('Verifiziere Code...', 'info');
                    
                    await this.mfaSetup.verifyAndEnableTOTP(code);
                    
                    this.showMessage('✅ 2FA erfolgreich aktiviert!', 'success');
                    
                    // Reset UI
                    document.getElementById('totpSetupStep1').style.display = 'block';
                    document.getElementById('totpSetupStep2').style.display = 'none';
                    document.getElementById('totpVerificationCode').value = '';
                    
                    // Reload status
                    setTimeout(() => this.loadMFAStatus(), 1000);
                } catch (error) {
                    this.showMessage('Fehler: ' + error.message, 'error');
                    document.getElementById('totpVerificationCode').value = '';
                    document.getElementById('totpVerificationCode').focus();
                }
            }

            cancelTOTPSetup() {
                document.getElementById('totpSetupStep1').style.display = 'block';
                document.getElementById('totpSetupStep2').style.display = 'none';
                document.getElementById('totpVerificationCode').value = '';
                this.currentSecret = null;
                this.currentQRCodeUrl = null;
            }

            async disableMFA() {
                if (!confirm('Möchten Sie 2FA wirklich deaktivieren? Ihr Konto wird weniger sicher sein.')) {
                    return;
                }

                try {
                    this.showMessage('Deaktiviere 2FA...', 'info');
                    
                    await this.mfaSetup.disableMFA();
                    
                    this.showMessage('✅ 2FA wurde deaktiviert.', 'success');
                    
                    // Reload status
                    setTimeout(() => this.loadMFAStatus(), 1000);
                } catch (error) {
                    this.showMessage('Fehler beim Deaktivieren: ' + error.message, 'error');
                }
            }

            showMessage(message, type = 'info') {
                const container = document.getElementById('messageContainer');
                container.innerHTML = `<div class="${type}">${message}</div>`;
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        // Initialisiere MFA Manager
        const mfaManager = new MFAManager();
        window.mfaManager = mfaManager;

        // Warte auf DOM und Auth-System
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => mfaManager.init(), 1000);
            });
        } else {
            setTimeout(() => mfaManager.init(), 1000);
        }
    </script>
</body>
</html>

