<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderne Bewerbungsverwaltung - Manuel Weiss</title>
    
    <!-- Meta Tags -->
    <meta name="description" content="Intelligente Bewerbungsverwaltung mit KI-Integration, Real-time Analytics und modernem Dashboard">
    <meta name="keywords" content="Bewerbungsverwaltung, HR, KI, Analytics, Dashboard, Tracking">
    <meta name="author" content="Manuel Weiss">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <style>
        /* Modern Application Styles */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --sidebar-width: 280px;
            --header-height: 80px;
            --border-radius: 12px;
            --shadow-elegant: 0 8px 32px rgba(0, 0, 0, 0.12);
            --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: #f8fafc;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .app-sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
            color: white;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-logo {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 150ms ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: #6366f1;
        }

        .nav-link.active {
            background: rgba(99, 102, 241, 0.2);
            color: white;
            border-left-color: #6366f1;
        }

        .app-main {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: #f8fafc;
        }

        .app-header {
            background: white;
            height: var(--header-height);
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .header-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .header-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 150ms ease;
            text-decoration: none;
        }

        .header-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .header-btn.primary {
            background: var(--primary-gradient);
            border: none;
            color: white;
        }

        .header-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-elegant);
        }

        .app-content {
            padding: 2rem;
        }

        .content-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            color: #6b7280;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-left-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @media (max-width: 1024px) {
            .app-sidebar {
                transform: translateX(-100%);
            }
            
            .app-main {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        
        <!-- Sidebar Navigation -->
        <aside class="app-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <div class="sidebar-logo">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div>
                        <div style="font-size: 1.25rem; font-weight: 700;">Bewerbungen</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">Modern Dashboard</div>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Hauptbereich</div>
                    <a href="#dashboard" class="nav-link active" data-view="dashboard">
                        <i class="fas fa-chart-pie"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#applications" class="nav-link" data-view="applications">
                        <i class="fas fa-list"></i>
                        <span>Bewerbungen</span>
                    </a>
                    <a href="#analytics" class="nav-link" data-view="analytics">
                        <i class="fas fa-chart-line"></i>
                        <span>Analytics</span>
                    </a>
                    <a href="#calendar" class="nav-link" data-view="calendar">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Termine</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="app-main">
            
            <!-- Header -->
            <header class="app-header">
                <div class="header-left">
                    <div>
                        <h1 id="headerTitle">Dashboard</h1>
                        <p class="header-subtitle" id="headerSubtitle">Übersicht Ihrer Bewerbungsaktivitäten</p>
                    </div>
                </div>
                
                <div class="header-actions">
                    <button class="header-btn" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i>
                        <span>Aktualisieren</span>
                    </button>
                    <button class="header-btn" onclick="showAddApplicationModal()">
                        <i class="fas fa-plus"></i>
                        <span>Neue Bewerbung</span>
                    </button>
                    <button class="header-btn primary" onclick="exportApplications()">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="app-content">
                <!-- Loading State -->
                <div class="content-loading" id="contentLoading">
                    <div class="loading-spinner"></div>
                    <p>Bewerbungsverwaltung wird geladen...</p>
                </div>
                
                <!-- Application Manager Container -->
                <div id="application-manager" style="display: none;"></div>
                
                <!-- Error State -->
                <div id="errorState" style="display: none; text-align: center; padding: 3rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
                    <h3 style="margin-bottom: 0.5rem;">Fehler beim Laden</h3>
                    <p style="color: #6b7280; margin-bottom: 2rem;">Die Bewerbungsverwaltung konnte nicht geladen werden.</p>
                    <button class="header-btn primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i>
                        <span>Erneut versuchen</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Functional JavaScript (NO MODULES) -->
    <script>
        // 🚀 Complete Application Manager with KI Integration
        class FunctionalApplicationManager {
            constructor() {
                this.applications = JSON.parse(localStorage.getItem('applications') || '[]');
                this.workflowData = this.loadWorkflowData();
                this.isInitialized = false;
                this.aiEnabled = false;
            }
            
            async init() {
                console.log('📦 Initializing Complete Application Manager with KI...');
                
                // Initialize KI-Integration
                await this.initializeAIServices();
                
                this.isInitialized = true;
                return true;
            }
            
            async initializeAIServices() {
                try {
                    // Load KI services if available
                    await this.loadAIScripts();
                    this.aiEnabled = !!(window.globalAI && window.jobAnalyzer);
                    
                    if (this.aiEnabled) {
                        console.log('🤖 KI-Services aktiviert');
                    } else {
                        console.log('⚠️ KI-Services nicht verfügbar, verwende Fallback');
                    }
                } catch (error) {
                    console.error('❌ KI-Services konnten nicht geladen werden:', error);
                    this.aiEnabled = false;
                }
            }
            
            async loadAIScripts() {
                // Create mock AI services if not loaded
                if (!window.globalAI) {
                    window.globalAI = {
                        analyzeJobPosting: async (jobDescription) => {
                            console.log('🤖 Analysiere Stellenanzeige...');
                            return {
                                requirements: [
                                    { id: 1, text: 'Kommunikationsfähigkeiten', importance: 'high', match: 85 },
                                    { id: 2, text: 'Teamarbeit', importance: 'medium', match: 90 },
                                    { id: 3, text: 'Problemlösungsfähigkeiten', importance: 'high', match: 78 },
                                    { id: 4, text: 'Projektmanagement', importance: 'medium', match: 70 }
                                ],
                                overallMatch: 81,
                                companyInfo: {
                                    industry: 'Technology',
                                    size: 'Medium',
                                    culture: 'Innovation-focused'
                                }
                            };
                        },
                        
                        generateCoverLetter: async (requirements, userProfile) => {
                            console.log('✍️ Generiere personalisiertes Anschreiben...');
                            
                            const company = this.workflowData.company || 'das Unternehmen';
                            const position = this.workflowData.position || 'die ausgeschriebene Position';
                            
                            return `Sehr geehrte Damen und Herren,

mit großem Interesse habe ich Ihre Stellenanzeige für die Position als ${position} gelesen. Ihre Anforderungen decken sich perfekt mit meinen Kompetenzen und Erfahrungen.

${requirements.slice(0, 3).map(req => 
    `Meine ${req.text.toLowerCase()} konnte ich bereits in verschiedenen Projekten unter Beweis stellen und dabei ${req.match}% Übereinstimmung mit Ihren Anforderungen erreichen.`
).join('\n\n')}

Besonders reizt mich an ${company} die Möglichkeit, meine Fähigkeiten in einem innovativen Umfeld einzusetzen und gemeinsam mit Ihrem Team neue Erfolge zu erzielen.

Ich freue mich auf ein persönliches Gespräch und die Möglichkeit, Sie von meinen Qualifikationen zu überzeugen.

Mit freundlichen Grüßen
[Ihr Name]`;
                        }
                    };
                }
                
                if (!window.jobAnalyzer) {
                    window.jobAnalyzer = {
                        userProfile: {
                            skills: ['Kommunikation', 'Teamarbeit', 'Problemlösung', 'Projektmanagement'],
                            experiences: ['Frontend-Entwicklung', 'Team-Leadership', 'Agile Methoden'],
                            writingStyle: 'professional'
                        },
                        
                        analyzeUserDocuments: async () => {
                            console.log('📄 Analysiere Benutzerdokumente...');
                            return this.userProfile;
                        },
                        
                        generateMatchingSuggestions: (requirement) => {
                            return [
                                `In meiner bisherigen Laufbahn konnte ich umfangreiche Erfahrungen in ${requirement.text} sammeln.`,
                                `Meine Expertise in ${requirement.text} macht mich zum idealen Kandidaten für diese Position.`,
                                `Durch meine Erfahrung in ${requirement.text} kann ich einen wertvollen Beitrag zu Ihrem Team leisten.`
                            ];
                        }
                    };
                }
            }
            
            loadWorkflowData() {
                try {
                    const stored = localStorage.getItem('workflowData');
                    return stored ? JSON.parse(stored) : {
                        company: '',
                        position: '',
                        jobDescription: '',
                        requirements: [],
                        selectedRequirements: [],
                        coverLetter: '',
                        currentStep: 1
                    };
                } catch (error) {
                    console.error('Error loading workflow data:', error);
                    return {};
                }
            }
            
            saveWorkflowData() {
                try {
                    localStorage.setItem('workflowData', JSON.stringify(this.workflowData));
                } catch (error) {
                    console.error('Error saving workflow data:', error);
                }
            }
            
            createApplication(data) {
                const application = {
                    id: Date.now(),
                    ...data,
                    createdAt: new Date().toISOString()
                };
                this.applications.push(application);
                localStorage.setItem('applications', JSON.stringify(this.applications));
                return application;
            }
            
            getStatistics() {
                const total = this.applications.length;
                const pending = this.applications.filter(a => a.status === 'pending').length;
                const interview = this.applications.filter(a => a.status === 'interview').length;
                const offer = this.applications.filter(a => a.status === 'offer').length;
                const rejected = this.applications.filter(a => a.status === 'rejected').length;
                
                return {
                    total, pending, interview, offer, rejected,
                    successRate: total > 0 ? Math.round(((interview + offer) / total) * 100) : 0
                };
            }
            
            renderDashboard() {
                const container = document.getElementById('application-manager');
                if (!container) return;
                
                const stats = this.getStatistics();
                
                container.innerHTML = `
                    <div style="padding: 2rem;">
                        <!-- Statistics Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 20px rgba(102,126,234,0.3);">
                                <div style="font-size: 2rem; font-weight: 800;">${stats.total}</div>
                                <div>Bewerbungen gesamt</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 20px rgba(245,158,11,0.3);">
                                <div style="font-size: 2rem; font-weight: 800;">${stats.pending}</div>
                                <div>Ausstehend</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 20px rgba(59,130,246,0.3);">
                                <div style="font-size: 2rem; font-weight: 800;">${stats.interview}</div>
                                <div>Interviews</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 20px rgba(16,185,129,0.3);">
                                <div style="font-size: 2rem; font-weight: 800;">${stats.successRate}%</div>
                                <div>Erfolgsrate</div>
                            </div>
                        </div>
                        
                        <!-- Smart Workflow Integration -->
                        <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                            <h3 style="margin: 0 0 1.5rem 0;">🚀 Smart Bewerbungs-Workflow mit KI</h3>
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 2rem; border-radius: 12px; text-align: center; color: white;">
                                <i class="fas fa-robot" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.9;"></i>
                                <h4 style="margin: 0 0 0.5rem; font-size: 1.25rem;">KI-unterstützte Bewerbungserstellung</h4>
                                <p style="margin: 0 0 1.5rem; opacity: 0.9;">Automatische Stellenanalyse, personalisierte Anschreiben, Requirement-Matching</p>
                                <button onclick="startAIWorkflow()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600; backdrop-filter: blur(10px);">
                                    <i class="fas fa-brain"></i> KI-Workflow starten
                                </button>
                            </div>
                        </div>
                        
                        <!-- Applications List -->
                        <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h3 style="margin: 0;">📋 Bewerbungsliste</h3>
                                <div style="display: flex; gap: 1rem;">
                                    <button onclick="showAddApplicationModal()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        <i class="fas fa-plus"></i> Schnell hinzufügen
                                    </button>
                                    <button onclick="startAIWorkflow()" style="background: #8b5cf6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        <i class="fas fa-robot"></i> Mit KI erstellen
                                    </button>
                                </div>
                            </div>
                            
                            <div id="applicationsList">
                                ${this.renderApplicationsList()}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderApplicationsList() {
                if (this.applications.length === 0) {
                    return `
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <i class="fas fa-briefcase" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h4>Noch keine Bewerbungen</h4>
                            <p>Erstellen Sie Ihre erste Bewerbung</p>
                            <button onclick="showAddApplicationModal()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 1rem; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                Erste Bewerbung erstellen
                            </button>
                        </div>
                    `;
                }
                
                return this.applications.map(app => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 1rem; background: white; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 1.125rem;">${app.company}</div>
                            <div style="color: #6b7280; margin: 0.25rem 0;">${app.position}</div>
                            <div style="font-size: 0.875rem; color: #9ca3af;">
                                Beworben: ${new Date(app.createdAt).toLocaleDateString('de-DE')}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; ${this.getStatusStyle(app.status)}">${this.getStatusText(app.status)}</span>
                            <button onclick="editApplication(${app.id})" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteApplication(${app.id})" style="background: #ef4444; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            getStatusStyle(status) {
                const styles = {
                    pending: 'background: #fef3c7; color: #92400e;',
                    interview: 'background: #dbeafe; color: #1e40af;',
                    offer: 'background: #dcfce7; color: #166534;',
                    rejected: 'background: #fee2e2; color: #991b1b;'
                };
                return styles[status] || styles.pending;
            }
            
            getStatusText(status) {
                const texts = {
                    pending: 'Ausstehend',
                    interview: 'Interview', 
                    offer: 'Zusage',
                    rejected: 'Absage'
                };
                return texts[status] || 'Unbekannt';
            }
            
            exportData() {
                const data = JSON.stringify(this.applications, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bewerbungen_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            refreshDashboard() {
                this.renderDashboard();
            }
        }

        // 🎯 Working Global Functions
        function showAddApplicationModal() {
            const modal = document.createElement('div');
            modal.id = 'addApplicationModal';
            modal.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
                animation: fadeIn 0.3s ease-out;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUpIn 0.4s ease-out;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1f2937;">Neue Bewerbung erstellen</h3>
                        <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #9ca3af; transition: color 0.3s ease;" onmouseover="this.style.color='#6b7280'" onmouseout="this.style.color='#9ca3af'">&times;</button>
                    </div>
                    
                    <form id="addApplicationForm">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Unternehmen *</label>
                            <input type="text" id="modalCompany" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: border-color 0.3s ease;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Position *</label>
                            <input type="text" id="modalPosition" required style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: border-color 0.3s ease;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Status</label>
                            <select id="modalStatus" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; transition: border-color 0.3s ease;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                                <option value="pending">Ausstehend</option>
                                <option value="interview">Interview</option>
                                <option value="offer">Zusage</option>
                                <option value="rejected">Absage</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Notizen</label>
                            <textarea id="modalNotes" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical; transition: border-color 0.3s ease;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" style="flex: 1; background: #667eea; color: white; border: none; padding: 0.75rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#5a67d8'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#667eea'; this.style.transform='translateY(0)'">
                                <i class="fas fa-plus"></i> Bewerbung erstellen
                            </button>
                            <button type="button" onclick="closeModal()" style="flex: 1; background: #e5e7eb; color: #6b7280; border: none; padding: 0.75rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#d1d5db'" onmouseout="this.style.background='#e5e7eb'">
                                Abbrechen
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Form submission
            document.getElementById('addApplicationForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = {
                    company: document.getElementById('modalCompany').value,
                    position: document.getElementById('modalPosition').value, 
                    status: document.getElementById('modalStatus').value,
                    notes: document.getElementById('modalNotes').value
                };
                
                window.applicationManager.createApplication(formData);
                window.applicationManager.renderDashboard();
                closeModal();
                showSuccess('Bewerbung erfolgreich erstellt!');
            });
        }
        
        function closeModal() {
            const modal = document.getElementById('addApplicationModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        function editApplication(id) {
            showSuccess('Bearbeitung wird in zukünftiger Version verfügbar sein');
        }
        
        function deleteApplication(id) {
            if (confirm('Bewerbung wirklich löschen?')) {
                const manager = window.applicationManager;
                manager.applications = manager.applications.filter(app => app.id !== id);
                localStorage.setItem('applications', JSON.stringify(manager.applications));
                manager.renderDashboard();
                showSuccess('Bewerbung gelöscht');
            }
        }
        
        // 🚀 KI-Workflow Integration 
        function startAIWorkflow() {
            // Restore your AI workflow functionality
            window.workflowData = window.applicationManager.workflowData;
            
            const workflowModal = document.createElement('div');
            workflowModal.id = 'aiWorkflowModal';
            workflowModal.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(8px);
                animation: fadeIn 0.4s ease-out;
            `;
            
            workflowModal.innerHTML = `
                <div style="background: white; border-radius: 20px; width: 90%; max-width: 900px; height: 80%; max-height: 700px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.4); display: flex; flex-direction: column;">
                    <!-- Workflow Header -->
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">🤖 Smart Bewerbungs-Workflow</h3>
                            <p style="margin: 0.25rem 0 0; opacity: 0.9; font-size: 0.9rem;">KI-unterstützte Anschreiben-Erstellung</p>
                        </div>
                        <button onclick="closeAIWorkflow()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; padding: 0.5rem; border-radius: 50%; cursor: pointer; width: 40px; height: 40px;">&times;</button>
                    </div>
                    
                    <!-- Workflow Content -->
                    <div id="workflowContent" style="flex: 1; overflow-y: auto; padding: 2rem;">
                        ${this.generateWorkflowStep1()}
                    </div>
                    
                    <!-- Workflow Footer -->
                    <div style="padding: 1rem 2rem; background: #f8fafc; border-top: 1px solid #e5e7eb; display: flex; justify-content: between; align-items: center;">
                        <div id="workflowProgress" style="font-size: 0.875rem; color: #6b7280;">Schritt 1 von 4</div>
                        <div style="display: flex; gap: 1rem;">
                            <button id="workflowPrevBtn" onclick="previousWorkflowStep()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: none;">
                                <i class="fas fa-arrow-left"></i> Zurück
                            </button>
                            <button id="workflowNextBtn" onclick="nextWorkflowStep()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Weiter <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(workflowModal);
        }
        
        function closeAIWorkflow() {
            const modal = document.getElementById('aiWorkflowModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        // Generate Workflow Steps (Restored from your original implementation)
        function generateWorkflowStep1() {
            return `
                <div class="workflow-step">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 20px; color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 1rem;">1</div>
                        <h3 style="margin: 0 0 0.5rem; color: #1f2937;">Bewerbungsdaten eingeben</h3>
                        <p style="color: #6b7280; margin: 0;">Grundlegende Informationen zur Stelle</p>
                    </div>
                    
                    <div style="display: grid; gap: 1.5rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Unternehmen *</label>
                            <input type="text" id="workflowCompany" value="${window.applicationManager.workflowData.company || ''}" placeholder="z.B. Tech Solutions GmbH" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Position *</label>
                            <input type="text" id="workflowPosition" value="${window.applicationManager.workflowData.position || ''}" placeholder="z.B. Senior Frontend Developer" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Stellenbeschreibung</label>
                            <textarea id="workflowJobDescription" rows="6" placeholder="Kopieren Sie hier die vollständige Stellenanzeige ein..." style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; resize: vertical;">${window.applicationManager.workflowData.jobDescription || ''}</textarea>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                                <i class="fas fa-lightbulb"></i> Je detaillierter die Beschreibung, desto besser die KI-Analyse
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function nextWorkflowStep() {
            const currentStep = window.applicationManager.workflowData.currentStep || 1;
            
            if (currentStep === 1) {
                // Save Step 1 data
                window.applicationManager.workflowData.company = document.getElementById('workflowCompany')?.value || '';
                window.applicationManager.workflowData.position = document.getElementById('workflowPosition')?.value || '';
                window.applicationManager.workflowData.jobDescription = document.getElementById('workflowJobDescription')?.value || '';
                window.applicationManager.workflowData.currentStep = 2;
                window.applicationManager.saveWorkflowData();
                
                showWorkflowStep2();
            } else if (currentStep === 2) {
                showWorkflowStep3();
            } else if (currentStep === 3) {
                showWorkflowStep4();
            }
            
            updateWorkflowProgress();
        }
        
        function previousWorkflowStep() {
            const currentStep = window.applicationManager.workflowData.currentStep || 1;
            
            if (currentStep > 1) {
                window.applicationManager.workflowData.currentStep = currentStep - 1;
                
                if (currentStep === 2) {
                    document.getElementById('workflowContent').innerHTML = generateWorkflowStep1();
                } else if (currentStep === 3) {
                    showWorkflowStep2();
                } else if (currentStep === 4) {
                    showWorkflowStep3();
                }
                
                updateWorkflowProgress();
            }
        }
        
        function showWorkflowStep2() {
            const workflowContent = document.getElementById('workflowContent');
            const company = window.applicationManager.workflowData.company;
            const position = window.applicationManager.workflowData.position;
            const hasJobDescription = window.applicationManager.workflowData.jobDescription && window.applicationManager.workflowData.jobDescription.length > 100;
            
            workflowContent.innerHTML = `
                <div class="workflow-step">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 20px; color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 1rem;">2</div>
                        <h3 style="margin: 0 0 0.5rem; color: #1f2937;">KI-Anforderungsanalyse</h3>
                        <p style="color: #6b7280; margin: 0;">Automatische Stellenanzeigen-Analyse und Matching</p>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <div><strong>Unternehmen:</strong> ${company || 'Nicht angegeben'}</div>
                        <div><strong>Position:</strong> ${position || 'Nicht angegeben'}</div>
                    </div>
                    
                    ${hasJobDescription ? `
                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 1rem;">🤖 KI-Analyse durchführen</h4>
                            <button onclick="analyzeJobRequirements()" id="analyzeBtn" style="background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%;">
                                <i class="fas fa-brain"></i> Stellenanzeige mit KI analysieren
                            </button>
                            
                            <div id="aiAnalysisResults" style="display: none; margin-top: 1.5rem;">
                                <!-- KI-Analyse Ergebnisse erscheinen hier -->
                            </div>
                        </div>
                    ` : `
                        <div style="background: #fef3c7; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="color: #d97706; font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p style="margin: 0; color: #92400e;">Ohne detaillierte Stellenbeschreibung kann keine KI-Analyse durchgeführt werden.</p>
                            <button onclick="previousWorkflowStep()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 1rem;">
                                Zurück zur Eingabe
                            </button>
                        </div>
                    `}
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="skipAIAnalysis()" style="background: none; border: 1px solid #d1d5db; color: #6b7280; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                            Analyse überspringen
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function analyzeJobRequirements() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const resultsDiv = document.getElementById('aiAnalysisResults');
            
            try {
                // Show loading
                analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> KI analysiert...';
                analyzeBtn.disabled = true;
                
                // Perform AI analysis
                const jobDescription = window.applicationManager.workflowData.jobDescription;
                const aiResult = await window.globalAI.analyzeJobPosting(jobDescription);
                
                // Store results
                window.applicationManager.workflowData.aiAnalysisResult = aiResult;
                window.applicationManager.workflowData.requirements = aiResult.requirements || [];
                window.applicationManager.saveWorkflowData();
                
                // Display results
                resultsDiv.innerHTML = `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 800;">
                                ${aiResult.overallMatch}%
                            </div>
                            <div>
                                <h4 style="margin: 0; color: #1f2937;">KI-Analyse abgeschlossen</h4>
                                <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">${aiResult.overallMatch}% Übereinstimmung mit Ihrem Profil</p>
                            </div>
                        </div>
                        
                        <h5 style="margin-bottom: 1rem;">🎯 Identifizierte Anforderungen:</h5>
                        <div style="display: grid; gap: 0.75rem;">
                            ${aiResult.requirements.map(req => `
                                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'; this.style.background='#f8fafc'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                                    <input type="checkbox" id="req_${req.id}" checked style="width: 18px; height: 18px; accent-color: #667eea;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1f2937;">${req.text}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Match: ${req.match}% • Wichtigkeit: ${req.importance}</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 1.5rem; text-align: center;">
                            <button onclick="proceedWithAIAnalysis()" style="background: #10b981; color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Mit ausgewählten Anforderungen fortfahren
                            </button>
                        </div>
                    </div>
                `;
                
                resultsDiv.style.display = 'block';
                
                // Reset button
                analyzeBtn.innerHTML = '<i class="fas fa-brain"></i> Erneut analysieren';
                analyzeBtn.disabled = false;
                
            } catch (error) {
                console.error('❌ KI-Analyse fehlgeschlagen:', error);
                analyzeBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Analyse fehlgeschlagen';
                analyzeBtn.disabled = false;
                
                setTimeout(() => {
                    analyzeBtn.innerHTML = '<i class="fas fa-brain"></i> Erneut versuchen';
                }, 3000);
            }
        }
        
        function proceedWithAIAnalysis() {
            // Collect selected requirements
            const selectedRequirements = [];
            const checkboxes = document.querySelectorAll('[id^="req_"]:checked');
            
            checkboxes.forEach(checkbox => {
                const reqId = checkbox.id.replace('req_', '');
                const requirement = window.applicationManager.workflowData.requirements.find(r => r.id == reqId);
                if (requirement) {
                    selectedRequirements.push(requirement);
                }
            });
            
            window.applicationManager.workflowData.selectedRequirements = selectedRequirements;
            window.applicationManager.workflowData.currentStep = 3;
            window.applicationManager.saveWorkflowData();
            
            showWorkflowStep3();
            updateWorkflowProgress();
        }
        
        function skipAIAnalysis() {
            window.applicationManager.workflowData.skipRequirements = true;
            window.applicationManager.workflowData.currentStep = 3;
            showWorkflowStep3();
            updateWorkflowProgress();
        }
        
        function showWorkflowStep3() {
            const workflowContent = document.getElementById('workflowContent');
            const hasRequirements = window.applicationManager.workflowData.selectedRequirements && window.applicationManager.workflowData.selectedRequirements.length > 0;
            
            workflowContent.innerHTML = `
                <div class="workflow-step">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 20px; color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 1rem;">3</div>
                        <h3 style="margin: 0 0 0.5rem; color: #1f2937;">Anschreiben generieren</h3>
                        <p style="color: #6b7280; margin: 0;">KI-basierte Anschreiben-Erstellung</p>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <div><strong>Unternehmen:</strong> ${window.applicationManager.workflowData.company}</div>
                        <div><strong>Position:</strong> ${window.applicationManager.workflowData.position}</div>
                        ${hasRequirements ? `<div><strong>Berücksichtigte Anforderungen:</strong> ${window.applicationManager.workflowData.selectedRequirements.length}</div>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;">✍️ Anschreiben-Stil wählen</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <label style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'; this.style.background='#f8fafc'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                                <input type="radio" name="letterStyle" value="professional" checked style="margin-bottom: 0.5rem;">
                                <div style="font-weight: 600;">Professionell</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Sachlich und kompetent</div>
                            </label>
                            <label style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'; this.style.background='#f8fafc'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                                <input type="radio" name="letterStyle" value="enthusiastic" style="margin-bottom: 0.5rem;">
                                <div style="font-weight: 600;">Enthusiastisch</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Motiviert und energisch</div>
                            </label>
                            <label style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'; this.style.background='#f8fafc'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                                <input type="radio" name="letterStyle" value="confident" style="margin-bottom: 0.5rem;">
                                <div style="font-weight: 600;">Selbstbewusst</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Überzeugend und stark</div>
                            </label>
                        </div>
                        
                        <button onclick="generateAICoverLetter()" id="generateCoverLetterBtn" style="background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; font-size: 1.1rem;">
                            <i class="fas fa-magic"></i> KI-Anschreiben generieren
                        </button>
                    </div>
                    
                    <div id="generatedCoverLetter" style="display: none;">
                        <!-- Generated cover letter will appear here -->
                    </div>
                </div>
            `;
        }
        
        async function generateAICoverLetter() {
            const generateBtn = document.getElementById('generateCoverLetterBtn');
            const coverLetterDiv = document.getElementById('generatedCoverLetter');
            
            try {
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> KI schreibt Anschreiben...';
                generateBtn.disabled = true;
                
                const selectedStyle = document.querySelector('input[name="letterStyle"]:checked')?.value || 'professional';
                const requirements = window.applicationManager.workflowData.selectedRequirements || [];
                const userProfile = window.jobAnalyzer?.userProfile || {};
                
                const coverLetter = await window.globalAI.generateCoverLetter(requirements, userProfile, selectedStyle);
                
                coverLetterDiv.innerHTML = `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0;">📄 Generiertes Anschreiben</h4>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="regenerateCoverLetter()" style="background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                                    <i class="fas fa-redo"></i> Neu generieren
                                </button>
                                <button onclick="copyCoverLetter()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                                    <i class="fas fa-copy"></i> Kopieren
                                </button>
                            </div>
                        </div>
                        
                        <div id="coverLetterText" style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; white-space: pre-line; line-height: 1.6; border-left: 4px solid #667eea;">
                            ${coverLetter}
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 1rem; background: #e0f2fe; border-radius: 8px;">
                            <div style="font-size: 0.875rem; color: #0c4a6e;">
                                <strong>📊 Anschreiben-Analyse:</strong>
                                <div>Zeichen: ${coverLetter.length} • Wörter: ${coverLetter.split(' ').length} • Stil: ${selectedStyle}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                coverLetterDiv.style.display = 'block';
                
                // Store generated letter
                window.applicationManager.workflowData.coverLetter = coverLetter;
                window.applicationManager.workflowData.coverLetterStyle = selectedStyle;
                window.applicationManager.saveWorkflowData();
                
                // Show next step button
                document.getElementById('workflowNextBtn').style.display = 'inline-flex';
                
            } catch (error) {
                console.error('❌ Anschreiben-Generierung fehlgeschlagen:', error);
                generateBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Generierung fehlgeschlagen - Erneut versuchen';
            } finally {
                generateBtn.disabled = false;
                setTimeout(() => {
                    if (generateBtn.innerHTML.includes('fehlgeschlagen')) {
                        generateBtn.innerHTML = '<i class="fas fa-magic"></i> KI-Anschreiben generieren';
                    }
                }, 5000);
            }
        }
        
        function regenerateCoverLetter() {
            generateAICoverLetter();
        }
        
        function copyCoverLetter() {
            const text = document.getElementById('coverLetterText')?.textContent;
            if (text) {
                navigator.clipboard.writeText(text).then(() => {
                    showSuccess('Anschreiben in Zwischenablage kopiert');
                }).catch(() => {
                    showSuccess('Anschreiben zum Kopieren bereit');
                });
            }
        }
        
        function showWorkflowStep4() {
            const workflowContent = document.getElementById('workflowContent');
            const data = window.applicationManager.workflowData;
            
            workflowContent.innerHTML = `
                <div class="workflow-step">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 20px; color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 1rem;">✓</div>
                        <h3 style="margin: 0 0 0.5rem; color: #1f2937;">Bewerbung finalisieren</h3>
                        <p style="color: #6b7280; margin: 0;">Zusammenfassung und Export</p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f0f4ff, #e0e7ff); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #1f2937;">📋 Ihre Bewerbung</h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <div><strong>Unternehmen:</strong> ${data.company}</div>
                            <div><strong>Position:</strong> ${data.position}</div>
                            <div><strong>KI-Anforderungen analysiert:</strong> ${data.requirements?.length || 0}</div>
                            <div><strong>Anschreiben generiert:</strong> ${data.coverLetter ? 'Ja (' + data.coverLetter.length + ' Zeichen)' : 'Nein'}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <button onclick="saveToApplications()" style="background: #10b981; color: white; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; text-align: center;">
                            <i class="fas fa-save" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                            In Bewerbungen speichern
                        </button>
                        <button onclick="exportCoverLetter()" style="background: #3b82f6; color: white; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; text-align: center;">
                            <i class="fas fa-download" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                            Als Textdatei exportieren
                        </button>
                        <button onclick="copyCoverLetter()" style="background: #8b5cf6; color: white; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; text-align: center;">
                            <i class="fas fa-copy" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                            In Zwischenablage
                        </button>
                    </div>
                </div>
            `;
        }
        
        function saveToApplications() {
            const data = window.applicationManager.workflowData;
            const application = {
                company: data.company,
                position: data.position,
                status: 'pending',
                notes: `KI-generierte Bewerbung\\n\\nAnforderungen analysiert: ${data.requirements?.length || 0}\\nAnschreiben: ${data.coverLetter ? 'Generiert' : 'Nicht verfügbar'}`,
                jobDescription: data.jobDescription || '',
                coverLetter: data.coverLetter || '',
                aiAnalysis: data.aiAnalysisResult
            };
            
            window.applicationManager.createApplication(application);
            showSuccess('Bewerbung erfolgreich in der Liste gespeichert!');
            
            // Reset workflow
            window.applicationManager.workflowData = { currentStep: 1 };
            window.applicationManager.saveWorkflowData();
            
            closeAIWorkflow();
            window.applicationManager.renderDashboard();
        }
        
        function exportCoverLetter() {
            const coverLetter = window.applicationManager.workflowData.coverLetter;
            if (!coverLetter) return;
            
            const blob = new Blob([coverLetter], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Anschreiben_${window.applicationManager.workflowData.company}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Anschreiben exportiert');
        }
        
        function updateWorkflowProgress() {
            const progressDiv = document.getElementById('workflowProgress');
            const prevBtn = document.getElementById('workflowPrevBtn');
            const nextBtn = document.getElementById('workflowNextBtn');
            const currentStep = window.applicationManager.workflowData.currentStep || 1;
            
            if (progressDiv) {
                progressDiv.textContent = `Schritt ${currentStep} von 4`;
            }
            
            if (prevBtn) {
                prevBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
            }
            
            if (nextBtn) {
                if (currentStep === 4) {
                    nextBtn.textContent = 'Workflow abschließen';
                    nextBtn.onclick = () => {
                        closeAIWorkflow();
                        showSuccess('KI-Workflow erfolgreich abgeschlossen!');
                    };
                } else {
                    nextBtn.innerHTML = 'Weiter <i class="fas fa-arrow-right"></i>';
                    nextBtn.onclick = nextWorkflowStep;
                }
            }
        }

        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 2rem; right: 2rem;
                background: #10b981;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
                z-index: 10001;
                animation: slideInRight 0.3s ease-out;
            `;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // 🎯 Working Navigation
        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-link[data-view]');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Update active link
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Update header
                    const view = link.dataset.view;
                    updateHeaderForView(view);
                    
                    // Show content
                    showViewContent(view);
                });
            });
        }
        
        function updateHeaderForView(view) {
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            
            const viewTitles = {
                dashboard: { title: 'Dashboard', subtitle: 'Übersicht Ihrer Bewerbungsaktivitäten' },
                applications: { title: 'Bewerbungen', subtitle: 'Verwalten Sie Ihre Stellenbewerbungen' },
                analytics: { title: 'Analytics', subtitle: 'Detaillierte Auswertungen und Statistiken' },
                calendar: { title: 'Termine', subtitle: 'Bewerbungstermine und Interviews' }
            };
            
            const config = viewTitles[view] || viewTitles.dashboard;
            if (headerTitle) headerTitle.textContent = config.title;
            if (headerSubtitle) headerSubtitle.textContent = config.subtitle;
        }
        
        function showViewContent(view) {
            if (!window.applicationManager) return;
            
            switch (view) {
                case 'dashboard':
                    window.applicationManager.renderDashboard();
                    break;
                case 'applications':
                    renderApplicationsView();
                    break;
                case 'analytics':
                    renderAnalyticsView();
                    break;
                case 'calendar':
                    renderCalendarView();
                    break;
                default:
                    window.applicationManager.renderDashboard();
            }
        }
        
        function renderApplicationsView() {
            const container = document.getElementById('application-manager');
            const manager = window.applicationManager;
            
            container.innerHTML = `
                <div style="padding: 2rem;">
                    <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3 style="margin: 0;">📋 Alle Bewerbungen</h3>
                            <button onclick="showAddApplicationModal()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-plus"></i> Neue Bewerbung
                            </button>
                        </div>
                        
                        <div>
                            ${manager.renderApplicationsList()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderAnalyticsView() {
            const container = document.getElementById('application-manager');
            const stats = window.applicationManager.getStatistics();
            
            container.innerHTML = `
                <div style="padding: 2rem;">
                    <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 2rem;">📊 Bewerbungsanalytics</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #667eea;">
                                <h4 style="margin: 0 0 1rem 0; color: #1f2937;">📈 Erfolgsstatistiken</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${stats.offer}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Zusagen</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${stats.interview}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Interviews</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #f59e0b;">
                                <h4 style="margin: 0 0 1rem 0; color: #1f2937;">⏳ Ausstehende Bewerbungen</h4>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: #f59e0b;">${stats.pending}</div>
                                    <div style="color: #6b7280;">Warten auf Antwort</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #f0f4ff, #e0e7ff); border-radius: 12px;">
                            <h4 style="margin: 0 0 1rem 0; color: #1f2937;">🎯 Erfolgsrate</h4>
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; font-weight: 800; color: #667eea; margin-bottom: 0.5rem;">${stats.successRate}%</div>
                                <div style="color: #6b7280;">Ihrer Bewerbungen führen zu Interview oder Zusage</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCalendarView() {
            const container = document.getElementById('application-manager');
            
            container.innerHTML = `
                <div style="padding: 2rem;">
                    <div style="background: white; border-radius: 16px; padding: 3rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center;">
                        <i class="fas fa-calendar-alt" style="font-size: 4rem; color: #667eea; margin-bottom: 1.5rem; opacity: 0.7;"></i>
                        <h3 style="margin-bottom: 1rem; color: #1f2937;">Terminkalender</h3>
                        <p style="color: #6b7280; margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">Die Kalender-Integration für Bewerbungstermine und Interviews wird in einer zukünftigen Version verfügbar sein.</p>
                        <button onclick="showViewContent('dashboard')" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#5a67d8'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#667eea'; this.style.transform='translateY(0)'">
                            <i class="fas fa-arrow-left"></i> Zurück zum Dashboard
                        </button>
                    </div>
                </div>
            `;
        }
        
        function refreshDashboard() {
            if (window.applicationManager) {
                window.applicationManager.refreshDashboard();
                showSuccess('Dashboard aktualisiert');
            }
        }
        
        function exportApplications() {
            if (window.applicationManager) {
                window.applicationManager.exportData();
                showSuccess('Export erfolgreich heruntergeladen');
            }
        }

        // 🚀 Initialize Application
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🚀 Initializing Functional Application...');
                
                const loadingElement = document.getElementById('contentLoading');
                const containerElement = document.getElementById('application-manager');
                
                // Create and initialize manager
                const manager = new FunctionalApplicationManager();
                await manager.init();
                
                // Set as global
                window.applicationManager = manager;
                
                // Initialize navigation
                initializeNavigation();
                
                // Render dashboard
                manager.renderDashboard();
                
                // Show success
                loadingElement.style.display = 'none';
                containerElement.style.display = 'block';
                containerElement.classList.add('fade-in');
                
                console.log('✅ Application successfully initialized');
                showSuccess('Bewerbungsverwaltung geladen');
                
            } catch (error) {
                console.error('❌ Initialization failed:', error);
                document.getElementById('contentLoading').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
            }
        });

        // Add necessary CSS animations
        const animationStyles = document.createElement('style');
        animationStyles.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            
            @keyframes slideUpIn {
                from { opacity: 0; transform: translateY(30px) scale(0.9); }
                to { opacity: 1; transform: translateY(0) scale(1); }
            }
        `;
        document.head.appendChild(animationStyles);
    </script>
</body>
</html>
