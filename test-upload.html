<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bildupload Test - Manuel Weiss</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: #007bff;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background: #f0f8ff;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>üß™ Bildupload Test</h1>
    
    <div class="test-section">
        <h2>Einfacher Bildupload Test</h2>
        <div class="upload-area" id="upload-area">
            <p>üìÅ Klicken Sie hier oder ziehen Sie ein Bild hierher</p>
            <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
        </div>
        
        <div id="image-container"></div>
    </div>
    
    <div class="test-section">
        <h2>Console Log</h2>
        <div class="log" id="log"></div>
        <button onclick="clearLog()">Log l√∂schen</button>
    </div>
    
    <div class="test-section">
        <h2>localStorage Status</h2>
        <div id="storage-status"></div>
        <button onclick="checkStorage()">Storage pr√ºfen</button>
        <button onclick="clearStorage()">Storage l√∂schen</button>
    </div>

    <script>
        // Logging-Funktion
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Auch in der Browser-Konsole ausgeben
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Storage-Funktionen
        function checkStorage() {
            const statusDiv = document.getElementById('storage-status');
            const activities = ['wohnmobil', 'fotobox', 'sup', 'ebike'];
            
            let status = '<h3>Storage Status:</h3>';
            
            activities.forEach(activity => {
                const images = JSON.parse(localStorage.getItem(`${activity}_images`) || '[]');
                status += `<p><strong>${activity}:</strong> ${images.length} Bilder</p>`;
            });
            
            const globalImages = JSON.parse(localStorage.getItem('globalImages') || '[]');
            status += `<p><strong>Globale Bilder:</strong> ${globalImages.length} Bilder</p>`;
            
            statusDiv.innerHTML = status;
        }

        function clearStorage() {
            if (confirm('M√∂chten Sie wirklich alle gespeicherten Bilder l√∂schen?')) {
                const activities = ['wohnmobil', 'fotobox', 'sup', 'ebike'];
                activities.forEach(activity => {
                    localStorage.removeItem(`${activity}_images`);
                });
                localStorage.removeItem('globalImages');
                log('Storage gel√∂scht', 'success');
                checkStorage();
            }
        }

        // Bildupload-Funktionalit√§t
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const imageContainer = document.getElementById('image-container');

        // Click to upload
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            log(`Verarbeite ${files.length} Datei(en)`, 'info');
            
            files.forEach((file, index) => {
                log(`Datei ${index + 1}: ${file.name} (${file.type}, ${file.size} bytes)`, 'info');
                
                if (!file.type.startsWith('image/')) {
                    log(`‚ùå Ung√ºltiger Dateityp: ${file.name}`, 'error');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    log(`‚ùå Datei zu gro√ü: ${file.name} (max. 10MB)`, 'error');
                    return;
                }
                
                // Bild verarbeiten
                processImage(file);
            });
        }

        function processImage(file) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const imageData = e.target.result;
                const imageId = Date.now() + Math.random();
                
                log(`‚úÖ Bild geladen: ${file.name}`, 'success');
                
                // Bild anzeigen
                displayImage(imageData, file.name, imageId);
                
                // In localStorage speichern (Test)
                saveImageToStorage('test', imageId, imageData, file.name);
                
                log(`üéâ Bild erfolgreich verarbeitet: ${file.name}`, 'success');
            };
            
            reader.onerror = (error) => {
                log(`‚ùå Fehler beim Lesen der Datei: ${file.name}`, 'error');
                console.error('FileReader error:', error);
            };
            
            reader.readAsDataURL(file);
        }

        function displayImage(imageData, filename, imageId) {
            const imageDiv = document.createElement('div');
            imageDiv.style.display = 'inline-block';
            imageDiv.style.margin = '10px';
            imageDiv.style.textAlign = 'center';
            
            imageDiv.innerHTML = `
                <img src="${imageData}" alt="${filename}" class="image-preview">
                <p style="margin: 5px 0; font-size: 12px;">${filename}</p>
                <button onclick="removeImage('${imageId}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">L√∂schen</button>
            `;
            
            imageContainer.appendChild(imageDiv);
        }

        function saveImageToStorage(activity, imageId, imageData, filename) {
            try {
                // Speichere in Aktivit√§ts-spezifischem Storage
                const storageKey = `${activity}_images`;
                let images = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                const imageInfo = {
                    id: imageId,
                    filename: filename,
                    title: filename,
                    description: '',
                    imageData: imageData,
                    uploadDate: new Date().toISOString(),
                    isUploaded: true,
                    activity: activity
                };
                
                images.push(imageInfo);
                localStorage.setItem(storageKey, JSON.stringify(images));
                
                // Speichere auch in globaler Datenbank
                let globalImages = JSON.parse(localStorage.getItem('globalImages') || '[]');
                globalImages.push(imageInfo);
                localStorage.setItem('globalImages', JSON.stringify(globalImages));
                
                log(`üíæ Bild gespeichert: ${filename}`, 'success');
                
            } catch (error) {
                log(`‚ùå Fehler beim Speichern: ${error.message}`, 'error');
            }
        }

        function removeImage(imageId) {
            // Entferne aus DOM
            const imageElements = document.querySelectorAll('[onclick*="' + imageId + '"]');
            imageElements.forEach(el => {
                el.parentElement.remove();
            });
            
            // Entferne aus Storage
            const activities = ['test', 'wohnmobil', 'fotobox', 'sup', 'ebike'];
            activities.forEach(activity => {
                const storageKey = `${activity}_images`;
                let images = JSON.parse(localStorage.getItem(storageKey) || '[]');
                images = images.filter(img => img.id !== imageId);
                localStorage.setItem(storageKey, JSON.stringify(images));
            });
            
            // Entferne aus globaler Datenbank
            let globalImages = JSON.parse(localStorage.getItem('globalImages') || '[]');
            globalImages = globalImages.filter(img => img.id !== imageId);
            localStorage.setItem('globalImages', JSON.stringify(globalImages));
            
            log(`üóëÔ∏è Bild entfernt: ${imageId}`, 'info');
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Test-Seite geladen', 'success');
            checkStorage();
        });
    </script>
</body>
</html>
