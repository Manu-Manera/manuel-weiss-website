# AI Investment System Streaming

## Overview

The AI Investment System Streaming module provides real-time data updates through WebSocket and Server-Sent Events (SSE). It enables live monitoring of signals, proposals, decisions, outcomes, and system events.

## Features

### Real-time Streaming
- **WebSocket Support**: Full-duplex communication for real-time updates
- **Server-Sent Events**: Fallback streaming for browsers with limited WebSocket support
- **Event Types**: Signal, Proposal, Decision, Outcome, Risk, System events
- **Auto-reconnection**: Automatic reconnection with exponential backoff
- **Heartbeat**: Keep-alive mechanism to maintain connections

### Event Types
- **Signal Events**: New signals from social media and news sources
- **Proposal Events**: Investment proposals generated by the system
- **Decision Events**: Investment decisions made by the system
- **Outcome Events**: Results of executed investments
- **Risk Events**: Risk assessments and warnings
- **System Events**: System health, metrics, and alerts

### Client Features
- **Event Handling**: Customizable event handlers for different event types
- **Subscription Management**: Subscribe/unsubscribe to specific event types
- **Connection Status**: Real-time connection status monitoring
- **Notifications**: Visual notifications for important events
- **Timeline**: Event timeline for monitoring system activity

## Architecture

### Components

1. **StreamingManager**: WebSocket connection management
2. **SSEHandler**: Server-Sent Events handling
3. **EventPublisher**: Event publishing and distribution
4. **StreamingClient**: JavaScript client for browser integration
5. **SSEClient**: Fallback SSE client

### Data Flow

```
Event Source → EventPublisher → StreamingManager/SSEHandler → Client
```

### Event Flow

```
Lambda Function → EventPublisher → WebSocket/SSE → Browser Client → Dashboard Update
```

## API Endpoints

### WebSocket Endpoints

#### WS /stream/ws
WebSocket connection for real-time streaming.

**Query Parameters**:
- `userId`: User identifier
- `apiKey`: API key for authentication

**Connection Events**:
- `$connect`: Connection established
- `$disconnect`: Connection closed
- `$default`: Message handling

**Message Types**:
- `subscribe`: Subscribe to event types
- `unsubscribe`: Unsubscribe from event types
- `ping`: Heartbeat ping
- `pong`: Heartbeat pong response

### Server-Sent Events

#### GET /stream/sse
Server-Sent Events endpoint for streaming.

**Query Parameters**:
- `userId`: User identifier
- `subscriptions`: Comma-separated list of event types
- `apiKey`: API key for authentication

**Event Stream**:
```
data: {"type": "signal", "data": {...}, "timestamp": "2024-01-15T10:30:00Z"}

data: {"type": "proposal", "data": {...}, "timestamp": "2024-01-15T10:30:00Z"}
```

## Client Usage

### Basic Setup

```javascript
// Initialize streaming client
const streamingClient = new StreamingClient({
    baseUrl: 'wss://api.ai-investment.com/v1',
    sseUrl: 'https://api.ai-investment.com/v1/stream/sse',
    apiKey: 'your-api-key',
    userId: 'user-123',
    subscriptions: ['signal', 'proposal', 'decision', 'outcome', 'risk', 'system']
});

// Handle events
streamingClient.on('signal', (data) => {
    console.log('New signal:', data);
    // Update dashboard
});

streamingClient.on('proposal', (data) => {
    console.log('New proposal:', data);
    // Show notification
});

streamingClient.on('decision', (data) => {
    console.log('New decision:', data);
    // Update decision table
});

streamingClient.on('outcome', (data) => {
    console.log('New outcome:', data);
    // Update performance metrics
});

streamingClient.on('risk', (data) => {
    console.log('Risk update:', data);
    // Show risk warning
});

streamingClient.on('system', (data) => {
    console.log('System update:', data);
    // Update system status
});
```

### Event Handling

```javascript
// Custom event handlers
streamingClient.on('connection', (data) => {
    console.log('Connected to streaming service');
    updateConnectionStatus('connected');
});

streamingClient.on('disconnection', (data) => {
    console.log('Disconnected from streaming service');
    updateConnectionStatus('disconnected');
});

streamingClient.on('error', (error) => {
    console.error('Streaming error:', error);
    showErrorNotification('Connection error');
});

// Handle specific events
streamingClient.on('signal', (data) => {
    // Update signals table
    updateSignalsTable(data);
    
    // Show notification
    showNotification('New Signal', `Signal from ${data.source}`, 'info');
});

streamingClient.on('proposal', (data) => {
    // Update proposals grid
    updateProposalsGrid(data);
    
    // Show notification
    showNotification('New Proposal', `Proposal for ${data.assets.join(', ')}`, 'success');
});
```

### Subscription Management

```javascript
// Subscribe to additional event types
streamingClient.subscribe(['risk', 'system']);

// Unsubscribe from event types
streamingClient.unsubscribe(['signal']);

// Get current subscriptions
console.log(streamingClient.subscriptions);
```

### Connection Management

```javascript
// Connect manually
streamingClient.connect();

// Disconnect
streamingClient.disconnect();

// Get connection status
const status = streamingClient.getStatus();
console.log('Connection status:', status);

// Check if connected
if (streamingClient.isConnected) {
    console.log('Connected to streaming service');
}
```

### Error Handling

```javascript
// Handle connection errors
streamingClient.on('error', (error) => {
    console.error('Streaming error:', error);
    
    // Show error notification
    showErrorNotification('Connection lost. Attempting to reconnect...');
    
    // Log error for debugging
    logError('Streaming error', error);
});

// Handle reconnection
streamingClient.on('connection', (data) => {
    if (data.reconnected) {
        showSuccessNotification('Reconnected to streaming service');
    }
});
```

## Event Data Structures

### Signal Event

```javascript
{
    "type": "signal",
    "data": {
        "id": "signal_123",
        "source": "twitter",
        "content": "Bitcoin adoption increasing",
        "scores": {
            "fused": 0.85,
            "sentiment": 0.8,
            "relevance": 0.9,
            "novelty": 0.7,
            "credibility": 0.8
        },
        "confidences": {
            "fused": 0.8
        },
        "timestamp": "2024-01-15T10:30:00Z"
    },
    "timestamp": "2024-01-15T10:30:00Z"
}
```

### Proposal Event

```javascript
{
    "type": "proposal",
    "data": {
        "id": "proposal_456",
        "thesis": "Bitcoin adoption is increasing",
        "assets": ["BTC", "ETH"],
        "size_pct": 0.05,
        "risk_score": 0.6,
        "expected_return": 0.08,
        "status": "proposed",
        "timestamp": "2024-01-15T10:30:00Z"
    },
    "timestamp": "2024-01-15T10:30:00Z"
}
```

### Decision Event

```javascript
{
    "type": "decision",
    "data": {
        "id": "decision_789",
        "proposal_id": "proposal_456",
        "action": "approve",
        "confidence": 0.8,
        "size_adjustment": 1.0,
        "timestamp": "2024-01-15T10:30:00Z"
    },
    "timestamp": "2024-01-15T10:30:00Z"
}
```

### Outcome Event

```javascript
{
    "type": "outcome",
    "data": {
        "id": "outcome_101",
        "proposal_id": "proposal_456",
        "return_pct": 0.04,
        "sharpe_ratio": 1.2,
        "max_drawdown": 0.02,
        "win_rate": 1.0,
        "timestamp": "2024-01-15T10:30:00Z"
    },
    "timestamp": "2024-01-15T10:30:00Z"
}
```

### Risk Event

```javascript
{
    "type": "risk",
    "data": {
        "risk_score": 0.6,
        "var": {
            "historical": 0.08,
            "parametric": 0.09,
            "monte_carlo": 0.085
        },
        "cvar": {
            "historical": 0.12,
            "monte_carlo": 0.125
        },
        "volatility": 0.2,
        "correlation": 0.65,
        "recommendations": [
            "Moderate risk - implement risk management measures"
        ],
        "timestamp": "2024-01-15T10:30:00Z"
    },
    "timestamp": "2024-01-15T10:30:00Z"
}
```

### System Event

```javascript
{
    "type": "system",
    "data": {
        "health": "healthy",
        "metrics": {
            "cpu_usage": 0.65,
            "memory_usage": 0.72,
            "response_time": 250
        },
        "alerts": [
            {
                "level": "warning",
                "message": "High CPU usage detected",
                "timestamp": "2024-01-15T10:30:00Z"
            }
        ],
        "timestamp": "2024-01-15T10:30:00Z"
    },
    "timestamp": "2024-01-15T10:30:00Z"
}
```

## Configuration

### Environment Variables

- `AWS_REGION`: AWS region (default: eu-central-1)
- `AWS_ACCESS_KEY_ID`: AWS access key
- `AWS_SECRET_ACCESS_KEY`: AWS secret key
- `STREAM_MESSAGES_TABLE_NAME`: DynamoDB table for stream messages
- `API_GATEWAY_ENDPOINT`: API Gateway WebSocket endpoint

### Client Configuration

```javascript
const streamingClient = new StreamingClient({
    baseUrl: 'wss://api.ai-investment.com/v1',
    sseUrl: 'https://api.ai-investment.com/v1/stream/sse',
    apiKey: 'your-api-key',
    userId: 'user-123',
    subscriptions: ['signal', 'proposal', 'decision', 'outcome', 'risk', 'system'],
    maxReconnectAttempts: 5,
    reconnectDelay: 1000
});
```

## Error Handling

### Connection Errors

```javascript
streamingClient.on('error', (error) => {
    console.error('Streaming error:', error);
    
    // Handle different error types
    switch (error.type) {
        case 'websocket':
            handleWebSocketError(error);
            break;
        case 'sse':
            handleSSEError(error);
            break;
        default:
            handleGenericError(error);
    }
});
```

### Reconnection Logic

```javascript
// Automatic reconnection with exponential backoff
streamingClient.on('disconnection', (data) => {
    console.log('Connection lost, attempting to reconnect...');
    
    // Show reconnection status
    showReconnectionStatus();
});

streamingClient.on('connection', (data) => {
    if (data.reconnected) {
        console.log('Reconnected successfully');
        hideReconnectionStatus();
    }
});
```

## Performance

### Optimization

- **Connection Pooling**: Efficient connection management
- **Message Batching**: Batch multiple events into single messages
- **Compression**: Gzip compression for large messages
- **Caching**: Client-side event caching
- **Throttling**: Rate limiting for high-frequency events

### Monitoring

```javascript
// Monitor connection status
setInterval(() => {
    const status = streamingClient.getStatus();
    console.log('Connection status:', status);
    
    // Update UI with connection status
    updateConnectionIndicator(status.isConnected);
}, 5000);
```

## Security

### Authentication

- **API Key**: Required for all connections
- **User ID**: User-specific event filtering
- **JWT Tokens**: Optional JWT authentication
- **Rate Limiting**: Connection rate limiting

### Data Protection

- **Encryption**: All data encrypted in transit (TLS)
- **Access Control**: User-specific event filtering
- **Audit Logging**: Connection and event logging
- **Data Anonymization**: PII anonymization

## Troubleshooting

### Common Issues

1. **Connection Failures**: Check API key and network connectivity
2. **Event Loss**: Implement client-side event queuing
3. **High Latency**: Check network conditions and server load
4. **Memory Leaks**: Properly clean up event handlers

### Debug Mode

```javascript
// Enable debug logging
streamingClient.on('debug', (data) => {
    console.log('Streaming debug:', data);
});

// Monitor connection events
streamingClient.on('connection', (data) => {
    console.log('Connection event:', data);
});

streamingClient.on('disconnection', (data) => {
    console.log('Disconnection event:', data);
});
```

## Testing

### Unit Tests

```bash
npm test
```

### Integration Tests

```bash
npm run test:integration
```

### Load Tests

```bash
npm run test:load
```

## Deployment

### CDK Deployment

```bash
npm run deploy
```

### Manual Deployment

```bash
# Build
npm run build

# Deploy to AWS
aws lambda update-function-code \
  --function-name ai-investment-streaming \
  --zip-file fileb://dist/index.js.zip
```

## Contributing

1. Follow TypeScript best practices
2. Add comprehensive tests
3. Update documentation
4. Follow conventional commits

## License

MIT License - see LICENSE file for details.
